<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>YOULINIRI PRO v5.0</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YOULINIRI PRO â€” Design System
   Estetica: Apple-premium + crypto-neon
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --blue:#007aff; --blue2:#0055d4; --green:#34c759; --red:#ff3b30;
  --orange:#ff9500; --purple:#af52de; --pink:#ff2d55;
  --bg:#f2f2f7; --bg2:#e5e5ea; --white:#ffffff;
  --text:#1c1c1e; --text2:#636366; --text3:#aeaeb2;
  --card:#ffffff; --border:rgba(0,0,0,0.08);
  --shadow:0 4px 20px rgba(0,0,0,0.08);
  --radius:18px; --radius-sm:10px;
  --youli:#f0c040; --youli2:#e6a800;
  --font:-apple-system,BlinkMacSystemFont,'SF Pro Text',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);font-family:var(--font);color:var(--text);overflow:hidden;height:100vh;display:flex}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:var(--bg2);border-radius:3px}

/* â”€â”€ OVERLAY/MODALI BASE â”€â”€ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(8px);z-index:900;display:flex;align-items:center;justify-content:center;animation:fade-in .2s ease}
.overlay.hidden{display:none}
@keyframes fade-in{from{opacity:0}to{opacity:1}}
.modal-card{background:var(--white);border-radius:24px;padding:28px 24px;width:340px;max-width:92vw;box-shadow:0 20px 60px rgba(0,0,0,0.25);animation:slide-up .25s cubic-bezier(.34,1.56,.64,1)}
@keyframes slide-up{from{opacity:0;transform:translateY(30px) scale(.96)}to{opacity:1;transform:none}}
.modal-title{font-size:20px;font-weight:700;margin-bottom:6px;color:var(--text)}
.modal-sub{font-size:13px;color:var(--text2);line-height:1.5;margin-bottom:16px}

/* â”€â”€ INPUT â”€â”€ */
.inp{width:100%;padding:12px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:15px;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;transition:border-color .2s}
.inp:focus{border-color:var(--blue)}
.inp-wrap{margin-bottom:12px}
.inp-label{font-size:12px;font-weight:600;color:var(--text2);letter-spacing:.5px;margin-bottom:5px;display:block}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{padding:13px 20px;border:none;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(--font)}
.btn-primary{background:var(--blue);color:#fff;width:100%}
.btn-primary:hover{background:var(--blue2)}
.btn-primary:active{transform:scale(.97)}
.btn-ghost{background:transparent;color:var(--blue);width:100%;margin-top:6px}
.btn-danger{background:var(--red);color:#fff;width:100%}
.btn-green{background:var(--green);color:#fff}
.btn-sm{padding:8px 14px;font-size:13px}
.btn-icon{background:var(--bg2);border:none;width:44px;height:44px;border-radius:50%;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s}
.btn-icon:hover{background:var(--bg)}
.btn-icon.active{background:var(--blue);color:#fff}
.btn-icon.red{background:var(--red);color:#fff}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRIVACY MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#privacy-overlay .modal-card{max-height:90vh;overflow-y:auto}
.privacy-body{max-height:220px;overflow-y:auto;background:var(--bg);border-radius:var(--radius-sm);padding:14px;font-size:12px;line-height:1.7;color:var(--text2);margin-bottom:16px}
.privacy-body h4{color:var(--text);margin:10px 0 4px}
.check-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;cursor:pointer;font-size:14px}
.check-row input[type=checkbox]{width:18px;height:18px;accent-color:var(--blue);cursor:pointer}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#auth-overlay .tabs{display:flex;background:var(--bg);border-radius:var(--radius-sm);padding:3px;margin-bottom:20px}
.tab-btn{flex:1;padding:8px;border:none;background:transparent;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;color:var(--text2);transition:all .2s}
.tab-btn.active{background:var(--white);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,0.12)}
.auth-logo{text-align:center;margin-bottom:20px}
.auth-logo-icon{font-size:48px;display:block;margin-bottom:8px}
.auth-logo h1{font-size:22px;font-weight:800;color:var(--blue)}
.auth-logo p{font-size:12px;color:var(--text3);letter-spacing:.5px}
.divider{border:none;border-top:1px solid var(--border);margin:14px 0}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT PRINCIPALE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{display:flex;height:100vh;width:100%;opacity:0;transition:opacity .3s}
#app.visible{opacity:1}

/* SIDEBAR */
.sidebar{width:300px;min-width:300px;background:var(--white);border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh}
.sidebar-header{padding:16px;background:linear-gradient(135deg,#007aff,#0055d4);color:#fff}
.me-row{display:flex;align-items:center;gap:10px}
.avatar{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0;cursor:pointer;position:relative}
.avatar-img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.status-dot{position:absolute;bottom:0;right:0;width:11px;height:11px;background:var(--green);border-radius:50%;border:2px solid #007aff}
.me-name{font-weight:700;font-size:15px}
.me-id{font-size:11px;opacity:.7;font-family:monospace;margin-top:2px;display:flex;align-items:center;gap:6px}
.copy-btn{font-size:10px;background:rgba(255,255,255,.2);border:none;color:#fff;padding:2px 7px;border-radius:20px;cursor:pointer}

/* WALLET */
.wallet-card{margin:12px;background:linear-gradient(135deg,#1c1c2e,#2d2d44);border-radius:16px;padding:14px;color:#fff}
.wallet-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.wallet-label{font-size:10px;letter-spacing:1px;opacity:.6;text-transform:uppercase}
.wallet-balance{font-size:28px;font-weight:900;color:var(--youli);line-height:1;margin:4px 0}
.wallet-sub{font-size:10px;opacity:.5}
.wallet-actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.btn-wallet{padding:8px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:.15s}
.btn-wallet.earn{background:rgba(240,192,64,.15);color:var(--youli);border:1px solid rgba(240,192,64,.3)}
.btn-wallet.redeem{background:var(--youli);color:#1c1c1e}
.btn-wallet:hover{opacity:.85}

/* CONTATTI */
.section-label{font-size:11px;font-weight:700;color:var(--text3);letter-spacing:.8px;padding:10px 14px 4px;text-transform:uppercase}
.contact-list{flex:1;overflow-y:auto;padding:4px 10px}
.contact-item{display:flex;align-items:center;gap:10px;padding:10px;border-radius:14px;cursor:pointer;transition:.15s;position:relative}
.contact-item:hover{background:var(--bg)}
.contact-item.active{background:#e8f0ff}
.c-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:700;color:#fff;flex-shrink:0;font-size:16px}
.c-info{flex:1;min-width:0}
.c-name{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-preview{font-size:12px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.c-time{font-size:10px;color:var(--text3)}
.unread-badge{background:var(--blue);color:#fff;border-radius:50%;width:18px;height:18px;font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center}
.online-dot{width:10px;height:10px;background:var(--green);border-radius:50%;border:2px solid #fff;position:absolute;bottom:8px;left:44px}

.sidebar-footer{padding:10px;border-top:1px solid var(--border);display:flex;gap:8px}
.sidebar-footer .btn-icon{flex:1;width:auto;border-radius:10px;font-size:15px}

/* CHAT MAIN */
.chat-main{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0}
.chat-header{background:var(--white);padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.chat-header-info{flex:1}
.chat-header-name{font-size:16px;font-weight:700}
.chat-header-status{font-size:12px;color:var(--green)}
.chat-header-actions{display:flex;gap:8px}
.chat-header-actions .btn-icon{width:38px;height:38px;font-size:17px}

/* MESSAGGI */
#msg-box{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px}
.msg-wrap{display:flex;flex-direction:column;max-width:72%;animation:msg-pop .2s ease}
@keyframes msg-pop{from{opacity:0;transform:scale(.95) translateY(6px)}to{opacity:1;transform:none}}
.msg-wrap.me{align-self:flex-end;align-items:flex-end}
.msg-wrap.them{align-self:flex-start;align-items:flex-start}
.msg-name{font-size:11px;color:var(--text3);margin-bottom:3px;font-weight:600}
.bubble{padding:10px 14px;border-radius:18px;font-size:14px;line-height:1.5;word-break:break-word;position:relative}
.me .bubble{background:var(--blue);color:#fff;border-bottom-right-radius:4px}
.them .bubble{background:var(--white);color:var(--text);border-bottom-left-radius:4px;box-shadow:0 1px 4px rgba(0,0,0,.06)}
.msg-time{font-size:10px;color:var(--text3);margin-top:3px;padding:0 4px}
.msg-status{font-size:10px;margin-left:4px}

/* File bubble */
.file-bubble{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:18px;max-width:240px;cursor:pointer}
.me .file-bubble{background:var(--blue2)}
.them .file-bubble{background:var(--white);box-shadow:0 1px 4px rgba(0,0,0,.06)}
.file-icon{font-size:28px;flex-shrink:0}
.file-info .file-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px}
.file-info .file-size{font-size:11px;opacity:.7}
.me .file-info{color:#fff}

/* Audio bubble */
.audio-bubble{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:18px;min-width:180px}
.me .audio-bubble{background:var(--blue2)}
.them .audio-bubble{background:var(--white);box-shadow:0 1px 4px rgba(0,0,0,.06)}
.audio-play{width:36px;height:36px;border-radius:50%;border:none;font-size:14px;cursor:pointer;flex-shrink:0}
.me .audio-play{background:rgba(255,255,255,.2);color:#fff}
.them .audio-play{background:var(--blue);color:#fff}
.audio-wave{flex:1;height:32px;border-radius:4px;background:repeating-linear-gradient(90deg,currentColor 0,currentColor 2px,transparent 2px,transparent 6px);opacity:.3}
.audio-duration{font-size:11px;opacity:.7}
.me .audio-duration,.me .audio-wave{color:#fff}

/* Poll bubble */
.poll-bubble{padding:12px;min-width:200px;max-width:280px}
.poll-q{font-weight:700;margin-bottom:10px;font-size:14px}
.poll-opt{padding:8px 12px;border-radius:8px;margin-bottom:6px;cursor:pointer;font-size:13px;border:none;width:100%;text-align:left;transition:.15s}
.me .poll-opt{background:rgba(255,255,255,.2);color:#fff}
.me .poll-opt:hover{background:rgba(255,255,255,.3)}
.them .poll-opt{background:var(--bg);color:var(--text)}
.them .poll-opt:hover{background:var(--bg2)}
.poll-bar{height:4px;border-radius:2px;margin-top:3px;background:var(--green);transition:width .5s}

/* MAP bubble */
.map-bubble{border-radius:14px;overflow:hidden;cursor:pointer;position:relative}
.map-bubble img{width:220px;height:120px;object-fit:cover;display:block}
.map-label{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.6));color:#fff;padding:8px;font-size:12px;font-weight:600}

/* YOULI reward */
.youli-bubble{background:linear-gradient(135deg,#1c1c2e,#2d2d44);border-radius:16px;padding:14px;color:#fff;text-align:center;min-width:200px}
.youli-amount{font-size:24px;font-weight:900;color:var(--youli)}
.youli-code{font-family:monospace;font-size:11px;background:rgba(240,192,64,.15);padding:6px;border-radius:6px;margin-top:8px;letter-spacing:1px;color:var(--youli)}

/* DAY DIVIDER */
.day-div{text-align:center;font-size:11px;color:var(--text3);margin:6px 0;font-weight:500}
.day-div span{background:var(--bg);padding:3px 10px;border-radius:20px}

/* INPUT BAR */
.input-bar{background:var(--white);border-top:1px solid var(--border);padding:10px 12px;display:flex;align-items:flex-end;gap:8px}
#msg-input{flex:1;border:1.5px solid var(--border);border-radius:22px;padding:10px 16px;font-size:15px;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;resize:none;max-height:120px;overflow-y:auto;line-height:1.4;transition:border-color .2s}
#msg-input:focus{border-color:var(--blue)}
.send-btn{width:44px;height:44px;border-radius:50%;background:var(--blue);border:none;color:#fff;font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s}
.send-btn:hover{background:var(--blue2)}
.send-btn:active{transform:scale(.92)}

/* ATTACH MENU */
.attach-menu{position:absolute;bottom:80px;left:12px;background:var(--white);border-radius:20px;padding:14px;box-shadow:0 8px 32px rgba(0,0,0,.15);display:grid;grid-template-columns:repeat(4,1fr);gap:10px;z-index:50;animation:slide-up .2s ease;border:1px solid var(--border)}
.attach-menu.hidden{display:none}
.attach-item{cursor:pointer;text-align:center;padding:8px;border-radius:12px;transition:.15s}
.attach-item:hover{background:var(--bg)}
.attach-item .icon{font-size:28px;display:block;margin-bottom:4px}
.attach-item .label{font-size:11px;font-weight:600;color:var(--text2)}

/* RECORDING UI */
.recording-bar{background:var(--white);border-top:1px solid var(--border);padding:14px 16px;display:flex;align-items:center;gap:12px}
.recording-bar.hidden{display:none}
.rec-indicator{width:12px;height:12px;border-radius:50%;background:var(--red);animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
.rec-time{font-family:monospace;font-size:18px;font-weight:700;flex:1;color:var(--text)}
.rec-wave{flex:2;height:30px;display:flex;align-items:center;gap:2px}
.rec-wave span{width:3px;border-radius:2px;background:var(--blue);animation:wave 1s ease-in-out infinite;flex-shrink:0}
.rec-wave span:nth-child(2n){animation-delay:.15s;height:60%}
.rec-wave span:nth-child(3n){animation-delay:.3s;height:80%}
@keyframes wave{0%,100%{transform:scaleY(1)}50%{transform:scaleY(1.8)}}

/* NO CHAT placeholder */
.no-chat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);gap:10px}
.no-chat-icon{font-size:64px}
.no-chat h3{font-size:18px;font-weight:600;color:var(--text2)}
.no-chat p{font-size:13px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHIAMATA (Video/Audio)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#call-overlay{position:fixed;inset:0;background:#0a0a0a;z-index:800;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:all .3s}
#call-overlay.hidden{display:none}
#call-overlay.pip-mode{position:fixed;bottom:20px;right:20px;width:320px;height:240px;border-radius:20px;overflow:hidden;inset:auto;z-index:1000;box-shadow:0 8px 40px rgba(0,0,0,.5);cursor:move}
#call-overlay.pip-mode .call-controls{padding:8px;gap:8px}
#call-overlay.pip-mode .call-controls .btn-icon{width:36px;height:36px;font-size:15px}
#call-overlay.pip-mode #call-label{display:none}
#call-overlay.pip-mode .call-info{display:none}

#remote-video{width:100%;height:100%;object-fit:cover;position:absolute;inset:0}
#local-video{position:absolute;bottom:80px;right:20px;width:120px;height:90px;border-radius:14px;object-fit:cover;border:2px solid rgba(255,255,255,.3);z-index:2;transition:.3s}
#call-overlay.pip-mode #local-video{width:70px;height:52px;bottom:50px;right:8px}

.call-bg{position:absolute;inset:0;background:radial-gradient(ellipse at center,#1a1a2e,#0a0a0a)}
.call-avatar{width:100px;height:100px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:700;color:#fff;margin-bottom:16px;position:relative;z-index:2;border:3px solid rgba(255,255,255,.2)}
.call-avatar::after{content:"";position:absolute;inset:-8px;border-radius:50%;border:2px solid rgba(255,255,255,.15);animation:ring-pulse 2s infinite}
@keyframes ring-pulse{0%{transform:scale(1);opacity:1}100%{transform:scale(1.4);opacity:0}}
.call-info{position:relative;z-index:2;text-align:center;color:#fff;margin-bottom:20px}
.call-info h2{font-size:26px;font-weight:700}
.call-info p{font-size:14px;opacity:.7;margin-top:6px}
#call-label{font-size:12px;color:rgba(255,255,255,.5);font-family:monospace;margin-top:4px}
.call-controls{display:flex;gap:12px;position:relative;z-index:2;padding:20px;background:rgba(0,0,0,.4);border-radius:30px;backdrop-filter:blur(10px)}
.call-controls .btn-icon{width:52px;height:52px;font-size:22px}

/* Filtri video */
#filter-bar{position:absolute;top:20px;left:0;right:0;display:flex;justify-content:center;gap:10px;z-index:3}
#filter-bar.hidden{display:none}
.filter-btn{padding:6px 14px;border-radius:20px;border:1.5px solid rgba(255,255,255,.3);background:rgba(0,0,0,.5);color:#fff;font-size:12px;cursor:pointer;backdrop-filter:blur(8px);transition:.15s}
.filter-btn:hover,.filter-btn.active{background:rgba(255,255,255,.2);border-color:#fff}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL INCOMING CALL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#incoming-overlay .modal-card{text-align:center}
.incoming-avatar{width:80px;height:80px;border-radius:50%;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:700;color:#fff}
.call-type-badge{font-size:11px;color:var(--text3);margin-bottom:14px}
.incoming-actions{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WALLET MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.youli-code-display{font-family:monospace;font-size:16px;letter-spacing:2px;background:linear-gradient(135deg,#1c1c2e,#2d2d44);color:var(--youli);padding:14px;border-radius:12px;text-align:center;margin:14px 0;user-select:all}
.history-item{padding:8px;border-radius:8px;background:var(--bg);margin-bottom:6px;font-size:12px;display:flex;justify-content:space-between;align-items:center}
.history-item .code{font-family:monospace;color:var(--text);font-size:11px}
.history-item .amount{font-weight:700;color:var(--youli)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SNAKE GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#snake-modal canvas{border-radius:12px;display:block;margin:0 auto;max-width:100%}
.snake-stats{display:flex;justify-content:space-between;margin-bottom:10px;font-size:13px;font-weight:600}
.snake-score{color:var(--blue)}
.snake-youli{color:var(--youli)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD CONTACT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scan-id-btn{background:var(--bg);border:1.5px dashed var(--border);border-radius:10px;padding:12px;text-align:center;cursor:pointer;font-size:13px;color:var(--text2);margin-bottom:12px;transition:.2s}
.scan-id-btn:hover{border-color:var(--blue);color:var(--blue)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}
@keyframes spin{to{transform:rotate(360deg)}}

@keyframes shake {
  0%,100%{transform:translateX(0)}
  20%{transform:translateX(-6px)}
  40%{transform:translateX(6px)}
  60%{transform:translateX(-4px)}
  80%{transform:translateX(4px)}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);background:rgba(28,28,30,.9);color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:500;z-index:9999;backdrop-filter:blur(10px);pointer-events:none;opacity:0;transition:opacity .3s;white-space:nowrap}
#toast.show{opacity:1}

/* â”€â”€ RESPONSIVE â”€â”€ */
@media(max-width:700px){
  .sidebar{width:100%;position:fixed;inset:0;z-index:50;transform:translateX(-100%);transition:.25s}
  .sidebar.open{transform:none}
  .chat-main{width:100%}
}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast"></div>

<!-- â•â•â• PRIVACY MODAL â•â•â• -->
<div class="overlay" id="privacy-overlay">
  <div class="modal-card" style="max-width:360px">
    <div style="text-align:center;font-size:40px;margin-bottom:10px">ğŸ”</div>
    <div class="modal-title" style="text-align:center">Privacy & Termini</div>
    <div class="modal-sub" style="text-align:center">Prima di continuare, leggi e accetta</div>
    <div class="privacy-body">
      <h4>1. Raccolta Dati</h4>
      YOULINIRI PRO non invia i tuoi dati a server esterni. Tutte le comunicazioni sono peer-to-peer crittografate tramite WebRTC. Username e password sono salvati localmente nel tuo browser.
      <h4>2. Messaggi</h4>
      I messaggi non sono conservati su server centrali. Vengono trasmessi direttamente tra utenti. Stai condividendo i contenuti sotto tua responsabilitÃ .
      <h4>3. Valuta YOULI</h4>
      YOULI Ã¨ una valuta virtuale a scopo ludico. I codici di riscatto non hanno valore monetario reale. Non Ã¨ previsto alcun rimborso.
      <h4>4. File e Media</h4>
      I file inviati transitano direttamente tra i dispositivi. Non garantiamo la disponibilitÃ  continua del canale.
      <h4>5. Cookie & Storage</h4>
      Utilizziamo localStorage e cookie solo per mantenere la sessione di login. Nessun cookie di terze parti.
      <h4>6. EtÃ  minima</h4>
      Devi avere almeno 13 anni per usare questo servizio.
    </div>
    <label class="check-row">
      <input type="checkbox" id="chk-privacy"/> Ho letto e accetto la Privacy Policy
    </label>
    <label class="check-row">
      <input type="checkbox" id="chk-terms"/> Accetto i Termini di Servizio
    </label>
    <button class="btn btn-primary" id="privacy-accept-btn" disabled>ACCETTA E CONTINUA</button>
  </div>
</div>

<!-- â•â•â• AUTH OVERLAY â•â•â• -->
<div class="overlay hidden" id="auth-overlay">
  <div class="modal-card">
    <div class="auth-logo">
      <span class="auth-logo-icon">ğŸ’¬</span>
      <h1>YOULINIRI PRO</h1>
      <p>CHAT Â· CALL Â· EARN YOULI</p>
    </div>
    <div class="tabs">
      <button class="tab-btn active" id="tab-login" onclick="switchTab('login')">Accedi</button>
      <button class="tab-btn" id="tab-signup" onclick="switchTab('signup')">Registrati</button>
    </div>
    <!-- LOGIN -->
    <div id="login-form">
      <div class="inp-wrap">
        <label class="inp-label">NOME UTENTE</label>
        <input class="inp" id="l-user" placeholder="Il tuo nome" autocomplete="username"/>
      </div>
      <div class="inp-wrap">
        <label class="inp-label">PASSWORD</label>
        <input class="inp" id="l-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password"/>
      </div>
      <button class="btn btn-primary" onclick="doLogin()">ACCEDI</button>
      <button class="btn btn-ghost" onclick="switchTab('signup')">Non hai un account? Registrati</button>
    </div>
    <!-- SIGNUP -->
    <div id="signup-form" style="display:none">
      <div class="inp-wrap">
        <label class="inp-label">NOME COMPLETO</label>
        <input class="inp" id="s-name" placeholder="Mario Rossi" autocomplete="name"/>
      </div>
      <div class="inp-wrap">
        <label class="inp-label">USERNAME</label>
        <input class="inp" id="s-user" placeholder="mario_rossi" autocomplete="username"/>
      </div>
      <div class="inp-wrap">
        <label class="inp-label">PASSWORD</label>
        <input class="inp" id="s-pass" type="password" placeholder="Min. 6 caratteri" autocomplete="new-password"/>
      </div>
      <div class="inp-wrap">
        <label class="inp-label">CONFERMA PASSWORD</label>
        <input class="inp" id="s-pass2" type="password" placeholder="Ripeti la password" autocomplete="new-password"/>
      </div>
      <button class="btn btn-primary" onclick="doSignup()">CREA ACCOUNT</button>
      <button class="btn btn-ghost" onclick="switchTab('login')">Hai giÃ  un account? Accedi</button>
    </div>
    <div id="auth-error" style="color:var(--red);font-size:13px;text-align:center;margin-top:10px;min-height:18px"></div>
  </div>
</div>

<!-- â•â•â• APP PRINCIPALE â•â•â• -->
<div id="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="me-row">
        <div class="avatar" id="my-avatar" onclick="showProfileModal()">
          <span id="my-avatar-letter">?</span>
          <div class="status-dot"></div>
        </div>
        <div style="flex:1">
          <div class="me-name" id="my-display-name">---</div>
          <div class="me-id">
            <span id="my-peer-id">connessione...</span>
            <button class="copy-btn" onclick="copyID()">copia</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WALLET -->
    <div class="wallet-card">
      <div class="wallet-top">
        <div>
          <div class="wallet-label">Saldo YOULI</div>
          <div class="wallet-balance" id="bal-val">0.00</div>
          <div class="wallet-sub">â‰ˆ valuta virtuale</div>
        </div>
        <div style="font-size:28px">ğŸª™</div>
      </div>
      <div class="wallet-actions">
        <button class="btn-wallet earn" onclick="openSnakeModal()">ğŸ Guadagna</button>
        <button class="btn-wallet redeem" onclick="showWalletModal()">ğŸ’° Riscatta</button>
      </div>
    </div>

    <!-- CONTATTI -->
    <div class="section-label">Conversazioni</div>
    <div class="contact-list" id="contact-list">
      <div style="text-align:center;padding:30px;color:var(--text3);font-size:13px">
        Nessun contatto ancora.<br/>Aggiungi un amico!
      </div>
    </div>

    <div class="sidebar-footer">
      <button class="btn-icon" title="Aggiungi contatto" onclick="showModal('add-contact-overlay')">â•</button>
      <button class="btn-icon" title="Nuovo gruppo" onclick="toast('Gruppi prossimamente!')">ğŸ‘¥</button>
      <button class="btn-icon" title="Impostazioni" onclick="showModal('settings-overlay')">âš™ï¸</button>
      <button class="btn-icon" title="Logout" onclick="doLogout()">ğŸšª</button>
    </div>
  </aside>

  <!-- CHAT MAIN -->
  <div class="chat-main" id="chat-main">
    <div class="no-chat" id="no-chat">
      <div class="no-chat-icon">ğŸ’¬</div>
      <h3>Seleziona una conversazione</h3>
      <p>Scegli un contatto dalla lista o aggiungine uno nuovo</p>
    </div>

    <!-- CHAT ATTIVA (nascosta finchÃ© non selezionata) -->
    <div id="active-chat" style="display:none;flex-direction:column;height:100%">
      <div class="chat-header">
        <div class="c-avatar" id="chat-hdr-avatar" style="width:38px;height:38px;font-size:16px">?</div>
        <div class="chat-header-info">
          <div class="chat-header-name" id="chat-hdr-name">---</div>
          <div class="chat-header-status" id="chat-hdr-status">â—  online</div>
        </div>
        <div class="chat-header-actions">
          <button class="btn-icon" title="Chiamata audio" onclick="startCall('audio')">ğŸ“</button>
          <button class="btn-icon" title="Videochiamata" onclick="startCall('video')">ğŸ“¹</button>
          <button class="btn-icon" title="Condividi schermo" onclick="startCall('screen')">ğŸ–¥ï¸</button>
          <button class="btn-icon" title="Altro" onclick="showChatMenu()">â‹¯</button>
        </div>
      </div>

      <div id="msg-box"></div>

      <!-- RECORDING BAR (nascosta di default) -->
      <div class="recording-bar hidden" id="recording-bar">
        <div class="rec-indicator"></div>
        <div class="rec-time" id="rec-time">0:00</div>
        <div class="rec-wave">
          <span style="height:40%"></span><span></span><span style="height:70%"></span>
          <span style="height:50%"></span><span style="height:90%"></span><span style="height:60%"></span>
          <span style="height:35%"></span><span style="height:80%"></span>
        </div>
        <button class="btn-icon red" onclick="stopRecording(true)" title="Elimina">âœ•</button>
        <button class="btn-icon active" onclick="stopRecording(false)" title="Invia">âœ“</button>
      </div>

      <!-- ATTACH MENU -->
      <div class="attach-menu hidden" id="attach-menu" style="position:relative;bottom:auto;left:auto">
        <div class="attach-item" onclick="triggerFile('any')"><span class="icon">ğŸ“</span><span class="label">File</span></div>
        <div class="attach-item" onclick="triggerFile('image/*')"><span class="icon">ğŸ–¼ï¸</span><span class="label">Foto</span></div>
        <div class="attach-item" onclick="triggerFile('video/*')"><span class="icon">ğŸ¬</span><span class="label">Video</span></div>
        <div class="attach-item" onclick="triggerFile('audio/*')"><span class="icon">ğŸµ</span><span class="label">Audio</span></div>
        <div class="attach-item" onclick="sendLocation()"><span class="icon">ğŸ“</span><span class="label">Posizione</span></div>
        <div class="attach-item" onclick="showModal('poll-overlay')"><span class="icon">ğŸ“Š</span><span class="label">Sondaggio</span></div>
        <div class="attach-item" onclick="sendYouliGift()"><span class="icon">ğŸª™</span><span class="label">YOULI</span></div>
        <div class="attach-item" onclick="openSnakeModal()"><span class="icon">ğŸ</span><span class="label">Snake</span></div>
      </div>

      <input type="file" id="file-input" hidden onchange="handleFileSend(this)"/>

      <div class="input-bar">
        <button class="btn-icon" onclick="toggleAttachMenu()" id="attach-btn">â•</button>
        <button class="btn-icon" id="record-btn" onclick="toggleRecording()" title="Registra audio">ğŸ™ï¸</button>
        <textarea id="msg-input" placeholder="Messaggio..." rows="1" onkeydown="handleMsgKey(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" onclick="sendTextMessage()">â¤</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• CHIAMATA IN CORSO â•â•â• -->
<div id="call-overlay" class="hidden">
  <div class="call-bg"></div>
  <video id="remote-video" autoplay playsinline></video>
  <video id="local-video" autoplay playsinline muted></video>

  <div id="filter-bar" class="hidden">
    <button class="filter-btn active" data-filter="none" onclick="applyFilter('none',this)">Normale</button>
    <button class="filter-btn" data-filter="grayscale(1)" onclick="applyFilter('grayscale(1)',this)">B&N</button>
    <button class="filter-btn" data-filter="sepia(1)" onclick="applyFilter('sepia(1)',this)">Vintage</button>
    <button class="filter-btn" data-filter="hue-rotate(90deg) saturate(2)" onclick="applyFilter('hue-rotate(90deg) saturate(2)',this)">Neon</button>
    <button class="filter-btn" data-filter="invert(.8) hue-rotate(180deg)" onclick="applyFilter('invert(.8) hue-rotate(180deg)',this)">Matrix</button>
    <button class="filter-btn" data-filter="blur(2px) brightness(1.2)" onclick="applyFilter('blur(2px) brightness(1.2)',this)">Soft</button>
  </div>

  <div class="call-avatar" id="call-avatar">?</div>
  <div class="call-info">
    <h2 id="call-name">---</h2>
    <p id="call-status">In chiamata...</p>
  </div>
  <div id="call-label">ğŸ”’ WebRTC End-to-End</div>

  <div class="call-controls">
    <button class="btn-icon" id="btn-mute" onclick="toggleMute()" title="Muto">ğŸ¤</button>
    <button class="btn-icon" id="btn-cam" onclick="toggleCamera()" title="Camera">ğŸ“·</button>
    <button class="btn-icon" id="btn-speaker" onclick="toggleSpeaker()" title="Altoparlante">ğŸ”Š</button>
    <button class="btn-icon" id="btn-filter" onclick="toggleFilters()" title="Filtri">âœ¨</button>
    <button class="btn-icon" id="btn-pip" onclick="togglePiP()" title="Picture in Picture">â›¶</button>
    <button class="btn-icon red" onclick="endCall()" title="Termina">ğŸ“µ</button>
  </div>
</div>

<!-- â•â•â• CHIAMATA IN ARRIVO â•â•â• -->
<div class="overlay hidden" id="incoming-overlay">
  <div class="modal-card">
    <div class="incoming-avatar" id="inc-avatar">?</div>
    <div style="font-size:18px;font-weight:700;text-align:center" id="inc-name">---</div>
    <div class="call-type-badge" id="inc-type">ğŸ“¹ Videochiamata in arrivo</div>
    <div class="incoming-actions">
      <button class="btn btn-danger btn-sm" onclick="rejectCall()">âœ• Rifiuta</button>
      <button class="btn btn-green btn-sm" onclick="acceptCall()">âœ“ Rispondi</button>
    </div>
  </div>
</div>

<!-- â•â•â• ADD CONTACT MODAL â•â•â• -->
<div class="overlay hidden" id="add-contact-overlay">
  <div class="modal-card">
    <div class="modal-title">â• Nuovo Contatto</div>
    <div class="modal-sub">Inserisci i dati del tuo contatto</div>
    <div class="scan-id-btn" onclick="pasteFromClipboard()">ğŸ“‹ Incolla ID dagli appunti</div>
    <div class="inp-wrap">
      <label class="inp-label">NOME</label>
      <input class="inp" id="fc-name" placeholder="Nome del contatto"/>
    </div>
    <div class="inp-wrap">
      <label class="inp-label">ID PEER (yln_...)</label>
      <input class="inp" id="fc-id" placeholder="yln_username"/>
    </div>
    <button class="btn btn-primary" onclick="addContact()">AGGIUNGI</button>
    <button class="btn btn-ghost" onclick="hideModal('add-contact-overlay')">Annulla</button>
  </div>
</div>

<!-- â•â•â• WALLET MODAL â•â•â• -->
<div class="overlay hidden" id="wallet-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸª™ Portafoglio YOULI</div>
    <div style="background:linear-gradient(135deg,#1c1c2e,#2d2d44);border-radius:14px;padding:16px;text-align:center;margin-bottom:16px">
      <div style="font-size:11px;color:rgba(255,255,255,.5);letter-spacing:1px;text-transform:uppercase">Saldo disponibile</div>
      <div style="font-size:36px;font-weight:900;color:var(--youli)" id="wallet-modal-bal">0.00</div>
      <div style="font-size:11px;color:rgba(255,255,255,.4)">YOULI TOKEN</div>
    </div>
    <div id="redeem-result" style="display:none">
      <div style="font-size:13px;font-weight:600;color:var(--text2);margin-bottom:6px">Codice Riscatto:</div>
      <div class="youli-code-display" id="redeem-code-display">---</div>
      <button class="btn btn-ghost btn-sm" style="width:auto;margin:4px auto" onclick="copyRedeemCode()">ğŸ“‹ Copia Codice</button>
    </div>
    <button class="btn btn-primary" onclick="riscattaYouli()" id="redeem-btn">ğŸ’° CONVERTI IN CODICE</button>
    <div class="modal-sub" style="margin-top:6px;font-size:11px">Minimo: 1.00 YOULI Â· converti il saldo in un codice voucher</div>
    <hr class="divider"/>
    <!-- INSERISCI CODICE YOULINIRI -->
    <div style="background:linear-gradient(135deg,rgba(240,192,64,.08),rgba(240,192,64,.03));border:1.5px solid rgba(240,192,64,.25);border-radius:14px;padding:14px;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--youli);letter-spacing:.5px;margin-bottom:10px">ğŸŸ INSERISCI CODICE YOULINIRI</div>
      <div style="display:flex;gap:8px;align-items:center">
        <input class="inp" id="code-input" placeholder="es. 5329HL7614a646hN593" style="flex:1;font-family:monospace;font-size:13px;letter-spacing:.5px;margin:0" oninput="resetCodeFeedback()" onkeydown="if(event.key==='Enter')redeemCode()"/>
        <button onclick="redeemCode()" style="background:var(--youli);border:none;border-radius:10px;padding:10px 14px;font-weight:700;font-size:13px;cursor:pointer;color:#1c1c1e;white-space:nowrap;flex-shrink:0">RISCATTA</button>
      </div>
      <div id="code-feedback" style="font-size:12px;margin-top:8px;min-height:16px;font-family:monospace;text-align:center"></div>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:8px">Storico</div>
    <div id="redeem-history" style="max-height:140px;overflow-y:auto"></div>
    <button class="btn btn-ghost" onclick="hideModal('wallet-overlay')">Chiudi</button>
  </div>
</div>

<!-- â•â•â• POLL MODAL â•â•â• -->
<div class="overlay hidden" id="poll-overlay">
  <div class="modal-card">
    <div class="modal-title">ğŸ“Š Nuovo Sondaggio</div>
    <div class="inp-wrap">
      <label class="inp-label">DOMANDA</label>
      <input class="inp" id="poll-q" placeholder="Cosa preferisci?"/>
    </div>
    <div class="inp-wrap">
      <label class="inp-label">OPZIONE A</label>
      <input class="inp" id="poll-a" placeholder="Prima opzione"/>
    </div>
    <div class="inp-wrap">
      <label class="inp-label">OPZIONE B</label>
      <input class="inp" id="poll-b" placeholder="Seconda opzione"/>
    </div>
    <button class="btn btn-primary" onclick="sendPoll()">INVIA SONDAGGIO</button>
    <button class="btn btn-ghost" onclick="hideModal('poll-overlay')">Annulla</button>
  </div>
</div>

<!-- â•â•â• SNAKE MODAL â•â•â• -->
<div class="overlay hidden" id="snake-overlay">
  <div class="modal-card" style="width:320px">
    <div class="snake-stats">
      <span>Punteggio: <span id="snake-score" class="snake-score">0</span></span>
      <span>+YOULI: <span id="snake-youli" class="snake-youli">+0.00</span></span>
    </div>
    <canvas id="sCanvas" width="280" height="280"></canvas>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin-top:8px">Usa le frecce o swipe per muoverti. Ogni mela = +0.10 YL</div>
    <button class="btn btn-danger" style="margin-top:10px" onclick="hideModal('snake-overlay');clearInterval(snakeLoop)">ESCI</button>
  </div>
</div>

<!-- â•â•â• SETTINGS MODAL â•â•â• -->
<div class="overlay hidden" id="settings-overlay">
  <div class="modal-card">
    <div class="modal-title">âš™ï¸ Impostazioni</div>
    <div class="inp-wrap" style="margin-top:12px">
      <label class="inp-label">CAMBIA PASSWORD</label>
      <input class="inp" id="new-pass" type="password" placeholder="Nuova password"/>
    </div>
    <button class="btn btn-primary" onclick="changePassword()">AGGIORNA PASSWORD</button>
    <hr class="divider"/>
    <button class="btn" style="background:var(--bg);color:var(--text);width:100%;margin-bottom:8px" onclick="exportData()">ğŸ“¤ Esporta Dati</button>
    <button class="btn btn-danger" onclick="resetApp()">ğŸ—‘ RESET TOTALE</button>
    <button class="btn btn-ghost" onclick="hideModal('settings-overlay')">Chiudi</button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   YOULINIRI PRO v5.0 â€” JavaScript Core
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ UTILITY â”€â”€ */
const $ = s => document.getElementById(s);
const qs = s => document.querySelector(s);

function toast(msg, dur = 2500) {
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(() => el.classList.remove('show'), dur);
}

function showModal(id) { $(id).classList.remove('hidden'); }
function hideModal(id) { $(id).classList.add('hidden'); }

/* â”€â”€ COOKIE HELPERS â”€â”€ */
function setCookie(name, value, days = 365) {
  const d = new Date(); d.setTime(d.getTime() + days * 86400000);
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${d.toUTCString()};path=/;SameSite=Strict`;
}
function getCookie(name) {
  const m = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : null;
}
function delCookie(name) { setCookie(name, '', -1); }

/* â”€â”€ STORAGE â”€â”€ */
const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
  del: k => localStorage.removeItem(k)
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRIVACY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initPrivacy() {
  if (getCookie('yl_privacy') === '1') {
    hideModal('privacy-overlay');
    initAuth();
    return;
  }
  showModal('privacy-overlay');
  const chk1 = $('chk-privacy'), chk2 = $('chk-terms'), btn = $('privacy-accept-btn');
  const check = () => { btn.disabled = !(chk1.checked && chk2.checked); };
  chk1.onchange = chk2.onchange = check;
  btn.onclick = () => {
    setCookie('yl_privacy', '1');
    hideModal('privacy-overlay');
    initAuth();
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentUser = null;

function initAuth() {
  // Auto-login via cookie
  const saved = getCookie('yl_session');
  if (saved) {
    const users = LS.get('yl_users') || {};
    if (users[saved]) {
      currentUser = users[saved];
      currentUser.username = saved;
      launchApp();
      return;
    }
  }
  showModal('auth-overlay');
}

function switchTab(tab) {
  $('tab-login').classList.toggle('active', tab === 'login');
  $('tab-signup').classList.toggle('active', tab === 'signup');
  $('login-form').style.display = tab === 'login' ? 'block' : 'none';
  $('signup-form').style.display = tab === 'signup' ? 'block' : 'none';
  $('auth-error').textContent = '';
}

function authError(msg) { $('auth-error').textContent = msg; }

function doLogin() {
  const u = $('l-user').value.trim(), p = $('l-pass').value;
  if (!u || !p) { authError('Compila tutti i campi'); return; }
  const users = LS.get('yl_users') || {};
  if (!users[u]) { authError('Utente non trovato'); return; }
  if (users[u].pass !== btoa(p)) { authError('Password errata'); return; }
  currentUser = { ...users[u], username: u };
  setCookie('yl_session', u);
  hideModal('auth-overlay');
  launchApp();
}

function doSignup() {
  const name = $('s-name').value.trim(), u = $('s-user').value.trim().toLowerCase().replace(/\s+/g,'_');
  const p = $('s-pass').value, p2 = $('s-pass2').value;
  if (!name || !u || !p) { authError('Compila tutti i campi'); return; }
  if (p.length < 6) { authError('Password minimo 6 caratteri'); return; }
  if (p !== p2) { authError('Le password non coincidono'); return; }
  if (!/^[a-z0-9_]+$/.test(u)) { authError('Username: solo lettere, numeri e _'); return; }
  const users = LS.get('yl_users') || {};
  if (users[u]) { authError('Username giÃ  in uso'); return; }
  users[u] = { name, pass: btoa(p), balance: 0, redemptions: [], emoji: randomEmoji() };
  LS.set('yl_users', users);
  currentUser = { ...users[u], username: u };
  setCookie('yl_session', u);
  hideModal('auth-overlay');
  launchApp();
}

function doLogout() {
  if (!confirm('Vuoi uscire?')) return;
  delCookie('yl_session');
  peer && peer.destroy();
  location.reload();
}

function changePassword() {
  const np = $('new-pass').value;
  if (np.length < 6) { toast('Password troppo corta'); return; }
  const users = LS.get('yl_users') || {};
  users[currentUser.username].pass = btoa(np);
  LS.set('yl_users', users);
  hideModal('settings-overlay');
  toast('âœ… Password aggiornata');
}

function randomEmoji() {
  const pool = ['ğŸ˜€','ğŸ¦Š','ğŸ¼','ğŸ¦','ğŸ¯','ğŸ»','ğŸ¦„','ğŸ¸','ğŸ™','ğŸ¦‹','ğŸ¬','ğŸ¦Š','ğŸ­','ğŸš€','ğŸŒŸ'];
  return pool[Math.floor(Math.random() * pool.length)];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PEER / APP INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let peer, myPeerID, contacts, connections = {}, callCon;

function launchApp() {
  contacts = LS.get(`yl_contacts_${currentUser.username}`) || [];
  // Inizializza PeerJS
  peer = new Peer('yln_' + currentUser.username);
  peer.on('open', id => {
    myPeerID = id;
    $('my-peer-id').textContent = id;
  });
  peer.on('connection', conn => {
    conn.on('open', () => { connections[conn.peer] = conn; updateContactStatus(conn.peer, true); });
    conn.on('data', d => receiveData(d, conn.peer));
    conn.on('close', () => { updateContactStatus(conn.peer, false); delete connections[conn.peer]; });
  });
  peer.on('call', handleIncomingCall);

  // UI
  $('my-display-name').textContent = currentUser.name;
  $('my-avatar-letter').textContent = currentUser.emoji || currentUser.name[0].toUpperCase();
  updateBalUI();
  renderContacts();
  $('app').classList.add('visible');

  // Keydown globale per snake
  document.addEventListener('keydown', snakeKeyHandler);
}

function saveUser() {
  const users = LS.get('yl_users') || {};
  users[currentUser.username] = { ...currentUser };
  LS.set('yl_users', users);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONTATTI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let activeContact = null;
let chatMessages = {}; // peer_id â†’ [{...}]

function saveContacts() { LS.set(`yl_contacts_${currentUser.username}`, contacts); }

function renderContacts() {
  const list = $('contact-list');
  if (contacts.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:30px;color:var(--text3);font-size:13px">Nessun contatto ancora.<br/>Aggiungi un amico!</div>';
    return;
  }
  list.innerHTML = '';
  contacts.forEach(c => {
    const div = document.createElement('div');
    div.className = 'contact-item' + (activeContact?.id === c.id ? ' active' : '');
    div.id = 'ci_' + c.id.replace(/[^a-z0-9]/gi,'_');
    const msgs = chatMessages[c.id] || [];
    const last = msgs[msgs.length - 1];
    div.innerHTML = `
      <div class="c-avatar" style="background:${colorFor(c.name)}">${c.emoji || c.name[0]}</div>
      <div class="c-info">
        <div class="c-name">${escHtml(c.name)}</div>
        <div class="c-preview">${last ? previewMsg(last) : '<span style="opacity:.5">Nessun messaggio</span>'}</div>
      </div>
      <div style="text-align:right;display:flex;flex-direction:column;align-items:flex-end;gap:4px">
        <div class="c-time">${last ? fmtTime(new Date(last.ts)) : ''}</div>
      </div>
    `;
    div.onclick = () => openChat(c);
    list.appendChild(div);
  });
}

function previewMsg(m) {
  if (m.type === 'text') return escHtml(m.content.slice(0, 40));
  if (m.type === 'file') return 'ğŸ“ ' + m.name;
  if (m.type === 'audio') return 'ğŸ™ï¸ Messaggio vocale';
  if (m.type === 'image') return 'ğŸ–¼ï¸ Immagine';
  if (m.type === 'video') return 'ğŸ¬ Video';
  if (m.type === 'poll') return 'ğŸ“Š Sondaggio';
  if (m.type === 'map') return 'ğŸ“ Posizione';
  if (m.type === 'youli_gift') return 'ğŸª™ Regalo YOULI';
  return 'ğŸ“¨ Messaggio';
}

function openChat(contact) {
  activeContact = contact;
  renderContacts();
  $('no-chat').style.display = 'none';
  const ac = $('active-chat'); ac.style.display = 'flex';
  const col = colorFor(contact.name);
  $('chat-hdr-avatar').style.background = col;
  $('chat-hdr-avatar').textContent = contact.emoji || contact.name[0];
  $('chat-hdr-name').textContent = contact.name;
  const isOnline = !!connections[contact.id];
  $('chat-hdr-status').textContent = isOnline ? 'â—  online' : 'â—‹  offline';
  $('chat-hdr-status').style.color = isOnline ? 'var(--green)' : 'var(--text3)';
  // Connetti se non ancora connesso
  if (!connections[contact.id]) connectTo(contact.id);
  renderMessages(contact.id);
}

function connectTo(peerId) {
  if (connections[peerId]) return;
  const conn = peer.connect(peerId, { reliable: true });
  conn.on('open', () => { connections[peerId] = conn; updateContactStatus(peerId, true); });
  conn.on('data', d => receiveData(d, peerId));
  conn.on('close', () => { updateContactStatus(peerId, false); delete connections[peerId]; });
}

function updateContactStatus(peerId, online) {
  const c = contacts.find(c => c.id === peerId);
  if (!c) return;
  if (activeContact?.id === peerId) {
    $('chat-hdr-status').textContent = online ? 'â—  online' : 'â—‹  offline';
    $('chat-hdr-status').style.color = online ? 'var(--green)' : 'var(--text3)';
  }
}

function addContact() {
  const name = $('fc-name').value.trim(), id = $('fc-id').value.trim();
  if (!name || !id) { toast('Compila nome e ID'); return; }
  if (contacts.find(c => c.id === id)) { toast('Contatto giÃ  presente'); return; }
  contacts.push({ name, id, emoji: randomEmoji() });
  saveContacts();
  renderContacts();
  hideModal('add-contact-overlay');
  $('fc-name').value = ''; $('fc-id').value = '';
  toast('âœ… Contatto aggiunto');
}

async function pasteFromClipboard() {
  try {
    const t = await navigator.clipboard.readText();
    $('fc-id').value = t.trim();
    toast('ID incollato');
  } catch { toast('Permesso clipboard negato'); }
}

function copyID() {
  navigator.clipboard.writeText(myPeerID).then(() => toast('ğŸ“‹ ID copiato!'));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MESSAGGI â€” RENDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderMessages(peerId) {
  const box = $('msg-box'); box.innerHTML = '';
  const msgs = chatMessages[peerId] || [];
  let lastDay = '';
  msgs.forEach(m => {
    const day = new Date(m.ts).toLocaleDateString('it-IT', { weekday:'long', day:'numeric', month:'long' });
    if (day !== lastDay) {
      const d = document.createElement('div'); d.className = 'day-div';
      d.innerHTML = `<span>${day}</span>`; box.appendChild(d); lastDay = day;
    }
    box.appendChild(buildMsgEl(m));
  });
  box.scrollTop = box.scrollHeight;
}

function buildMsgEl(m) {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrap ' + m.side;
  const me = m.side === 'me';
  let inner = '';

  if (m.type === 'text') {
    inner = `<div class="bubble">${escHtml(m.content).replace(/\n/g,'<br/>')}</div>`;
  } else if (m.type === 'image') {
    inner = `<img src="${m.data}" style="max-width:220px;border-radius:14px;display:block;cursor:pointer" onclick="window.open(this.src)"/>`;
  } else if (m.type === 'video') {
    inner = `<video src="${m.data}" controls style="max-width:240px;border-radius:14px;display:block"></video>`;
  } else if (m.type === 'audio' && m.isVoice) {
    inner = `<div class="audio-bubble">
      <button class="audio-play" onclick="playAudio('${m.data}',this)">â–¶</button>
      <div class="audio-wave"></div>
      <span class="audio-duration">${m.dur || '0:00'}</span>
    </div>`;
  } else if (m.type === 'file' || m.type === 'audio') {
    const icon = fileIcon(m.name || m.type);
    inner = `<a href="${m.data}" download="${escHtml(m.name||'file')}" style="text-decoration:none">
      <div class="file-bubble">
        <div class="file-icon">${icon}</div>
        <div class="file-info">
          <div class="file-name">${escHtml(m.name||'file')}</div>
          <div class="file-size">${m.size || ''} â€¢ Tocca per scaricare</div>
        </div>
      </div>
    </a>`;
  } else if (m.type === 'poll') {
    inner = `<div class="bubble poll-bubble">
      <div class="poll-q">ğŸ“Š ${escHtml(m.q)}</div>
      <button class="poll-opt" onclick="votePoll(this,'${m.id}','a')">${escHtml(m.a)} <span id="pv_${m.id}_a"></span></button>
      <button class="poll-opt" onclick="votePoll(this,'${m.id}','b')">${escHtml(m.b)} <span id="pv_${m.id}_b"></span></button>
    </div>`;
  } else if (m.type === 'map') {
    inner = `<a href="${m.url}" target="_blank" style="text-decoration:none">
      <div class="map-bubble">
        <img src="https://api.mapbox.com/styles/v1/mapbox/streets-v11/static/${m.lng},${m.lat},14,0/220x120?access_token=pk.placeholder" onerror="this.src='https://via.placeholder.com/220x120/007aff/fff?text=ğŸ“+Posizione'" alt="Mappa"/>
        <div class="map-label">ğŸ“ ${m.lat.toFixed(4)}, ${m.lng.toFixed(4)}</div>
      </div>
    </a>`;
  } else if (m.type === 'youli_gift') {
    inner = `<div class="youli-bubble">
      <div style="font-size:24px">ğŸª™</div>
      <div style="font-size:12px;opacity:.6;margin:4px 0">Regalo YOULI da ${escHtml(m.from||'?')}</div>
      <div class="youli-amount">+${m.amount} YL</div>
      <div class="youli-code">${m.code}</div>
    </div>`;
  }

  wrap.innerHTML = `
    ${!me ? `<div class="msg-name">${escHtml(m.fromName||'')}</div>` : ''}
    ${inner}
    <div class="msg-time">${fmtTime(new Date(m.ts))} ${me ? '<span class="msg-status">âœ“</span>' : ''}</div>
  `;
  return wrap;
}

function appendMsg(m) {
  const box = $('msg-box');
  box.appendChild(buildMsgEl(m));
  box.scrollTop = box.scrollHeight;
  renderContacts(); // aggiorna preview
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INVIO MESSAGGI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function saveAndShow(peerId, m) {
  if (!chatMessages[peerId]) chatMessages[peerId] = [];
  chatMessages[peerId].push(m);
  appendMsg(m);
}

function sendPayload(data) {
  if (!activeContact) { toast('Scegli un contatto'); return; }
  const peerId = activeContact.id;
  connectTo(peerId); // assicura connessione
  const send = () => {
    try { connections[peerId].send({ ...data, from: myPeerID, fromName: currentUser.name }); } catch(e) {}
  };
  if (connections[peerId]?.open) send();
  else setTimeout(send, 800);
}

function sendTextMessage() {
  const val = $('msg-input').value.trim();
  if (!val || !activeContact) return;
  const m = { type:'text', content:val, ts:Date.now(), side:'me' };
  saveAndShow(activeContact.id, m);
  sendPayload(m);
  $('msg-input').value = ''; autoResize($('msg-input'));
}

function handleMsgKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendTextMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

/* â”€â”€â”€ FILE â”€â”€â”€ */
function triggerFile(accept) {
  const fi = $('file-input');
  fi.accept = accept === 'any' ? '' : accept;
  fi.click();
  toggleAttachMenu();
}

function fileIcon(name) {
  const ext = (name||'').split('.').pop().toLowerCase();
  const map = {
    pdf:'ğŸ“„', py:'ğŸ', js:'ğŸ“œ', html:'ğŸŒ', css:'ğŸ¨', php:'ğŸ˜', txt:'ğŸ“',
    apk:'ğŸ“±', exe:'ğŸ’¾', zip:'ğŸ—œï¸', rar:'ğŸ—œï¸', mp3:'ğŸµ', wav:'ğŸµ',
    mp4:'ğŸ¬', avi:'ğŸ¬', mov:'ğŸ¬', jpg:'ğŸ–¼ï¸', jpeg:'ğŸ–¼ï¸', png:'ğŸ–¼ï¸',
    gif:'ğŸ–¼ï¸', svg:'ğŸ–¼ï¸', doc:'ğŸ“', docx:'ğŸ“', xls:'ğŸ“Š', xlsx:'ğŸ“Š',
    ppt:'ğŸ“½ï¸', pptx:'ğŸ“½ï¸', json:'ğŸ”§', xml:'ğŸ”§', sql:'ğŸ—„ï¸', db:'ğŸ—„ï¸'
  };
  return map[ext] || 'ğŸ“';
}

function fmtSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1024/1024).toFixed(1) + ' MB';
}

function handleFileSend(input) {
  const file = input.files[0]; if (!file) return;
  const r = new FileReader();
  r.onload = e => {
    const isImg = file.type.startsWith('image/');
    const isVid = file.type.startsWith('video/');
    const isAudio = file.type.startsWith('audio/');
    const type = isImg ? 'image' : isVid ? 'video' : isAudio ? 'audio' : 'file';
    const m = { type, name:file.name, data:e.target.result, size:fmtSize(file.size), ts:Date.now(), side:'me' };
    saveAndShow(activeContact.id, m);
    sendPayload(m);
  };
  r.readAsDataURL(file);
  input.value = '';
}

/* â”€â”€â”€ POSIZIONE â”€â”€â”€ */
function sendLocation() {
  toggleAttachMenu();
  navigator.geolocation.getCurrentPosition(p => {
    const m = { type:'map', lat:p.coords.latitude, lng:p.coords.longitude, url:`https://www.google.com/maps?q=${p.coords.latitude},${p.coords.longitude}`, ts:Date.now(), side:'me' };
    saveAndShow(activeContact.id, m);
    sendPayload(m);
  }, () => toast('Posizione negata'));
}

/* â”€â”€â”€ POLL â”€â”€â”€ */
function sendPoll() {
  const q = $('poll-q').value.trim(), a = $('poll-a').value.trim(), b = $('poll-b').value.trim();
  if (!q || !a || !b) { toast('Compila tutti i campi'); return; }
  const m = { type:'poll', q, a, b, id:'p'+Date.now(), ts:Date.now(), side:'me', votes:{a:0,b:0} };
  saveAndShow(activeContact.id, m);
  sendPayload(m);
  hideModal('poll-overlay');
  $('poll-q').value = ''; $('poll-a').value = ''; $('poll-b').value = '';
}

function votePoll(btn, pollId, opt) {
  btn.style.background = 'var(--blue)'; btn.style.color = '#fff';
  toast('Votato!');
}

/* â”€â”€â”€ AUDIO PLAYBACK â”€â”€â”€ */
function playAudio(src, btn) {
  const audio = new Audio(src);
  btn.textContent = 'â¸';
  audio.play();
  audio.onended = () => { btn.textContent = 'â–¶'; };
}

/* â”€â”€â”€ YOULI GIFT â”€â”€â”€ */
function sendYouliGift() {
  toggleAttachMenu();
  const amt = parseFloat(prompt('Quanti YOULI vuoi inviare?') || '0');
  if (!amt || amt <= 0 || amt > currentUser.balance) { toast('Saldo insufficiente o importo non valido'); return; }
  currentUser.balance = parseFloat((currentUser.balance - amt).toFixed(2));
  saveUser(); updateBalUI();
  const code = genYouliCode();
  const m = { type:'youli_gift', amount:amt.toFixed(2), code, from:currentUser.name, ts:Date.now(), side:'me' };
  saveAndShow(activeContact.id, m);
  sendPayload(m);
}

/* â”€â”€â”€ RICEVI â”€â”€â”€ */
function receiveData(data, fromPeerId) {
  if (data.type === 'call_signal') return; // gestito da PeerJS
  const contact = contacts.find(c => c.id === fromPeerId);
  const m = { ...data, side:'them', fromName: contact?.name || data.fromName || fromPeerId };
  if (!chatMessages[fromPeerId]) chatMessages[fromPeerId] = [];
  chatMessages[fromPeerId].push(m);
  // Mostra solo se la chat Ã¨ aperta con questo contatto
  if (activeContact?.id === fromPeerId) appendMsg(m);
  // YOULI automatico
  if (data.type === 'youli_gift') {
    currentUser.balance = parseFloat((currentUser.balance + parseFloat(data.amount)).toFixed(2));
    saveUser(); updateBalUI();
    toast(`ğŸª™ Hai ricevuto ${data.amount} YOULI!`);
  }
  renderContacts();
}

/* â”€â”€â”€ ATTACH MENU â”€â”€â”€ */
function toggleAttachMenu() {
  $('attach-menu').classList.toggle('hidden');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REGISTRAZIONE AUDIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let mediaRec = null, audioChunks = [], recTimerInterval, recSeconds = 0;

function toggleRecording() {
  if (mediaRec && mediaRec.state === 'recording') return;
  startRecording();
}

async function startRecording() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRec = new MediaRecorder(stream);
    audioChunks = []; recSeconds = 0;
    mediaRec.ondataavailable = e => audioChunks.push(e.data);
    mediaRec.start();
    $('recording-bar').classList.remove('hidden');
    $('msg-input').style.display = 'none';
    $('send-btn').style.display = 'none';
    $('record-btn').style.background = 'var(--red)';
    recTimerInterval = setInterval(() => {
      recSeconds++;
      const m = String(Math.floor(recSeconds/60)).padStart(1,'0');
      const s = String(recSeconds%60).padStart(2,'0');
      $('rec-time').textContent = `${m}:${s}`;
    }, 1000);
  } catch(e) { toast('Microfono non disponibile'); }
}

function stopRecording(cancel) {
  if (!mediaRec) return;
  clearInterval(recTimerInterval);
  mediaRec.onstop = () => {
    if (!cancel) {
      const blob = new Blob(audioChunks, { type:'audio/webm' });
      const reader = new FileReader();
      reader.onload = e => {
        const m = { type:'audio', isVoice:true, data:e.target.result, dur:$('rec-time').textContent, ts:Date.now(), side:'me' };
        saveAndShow(activeContact.id, m);
        sendPayload(m);
      };
      reader.readAsDataURL(blob);
    }
    mediaRec.stream.getTracks().forEach(t => t.stop());
    mediaRec = null;
  };
  mediaRec.stop();
  $('recording-bar').classList.add('hidden');
  $('msg-input').style.display = '';
  $('send-btn').style.display = '';
  $('record-btn').style.background = '';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHIAMATE â€” WebRTC via PeerJS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let localStream = null, currentCall = null, callType = 'audio';
let isMuted = false, isCamOff = false, isPiP = false;

async function startCall(type) {
  if (!activeContact) { toast('Seleziona un contatto'); return; }
  callType = type;
  try {
    let stream;
    if (type === 'screen') {
      stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
    } else {
      stream = await navigator.mediaDevices.getUserMedia({
        video: type === 'video' ? { facingMode:'user' } : false,
        audio: true
      });
    }
    localStream = stream;
    $('local-video').srcObject = stream;
    if (type !== 'audio') $('local-video').style.display = 'block';
    else $('local-video').style.display = 'none';

    currentCall = peer.call(activeContact.id, stream, {
      metadata: { type, callerName: currentUser.name }
    });
    currentCall.on('stream', remoteStream => {
      $('remote-video').srcObject = remoteStream;
      $('remote-video').style.display = 'block';
      $('call-avatar').style.display = 'none';
      $('call-status').textContent = 'ğŸ”´ In chiamata';
    });
    currentCall.on('close', cleanupCall);

    showCallUI(activeContact.name, type, true);
  } catch(e) {
    toast('Impossibile accedere a fotocamera/microfono: ' + e.message);
  }
}

function handleIncomingCall(call) {
  currentCall = call;
  const meta = call.metadata || {};
  callType = meta.type || 'audio';
  const name = meta.callerName || 'Sconosciuto';
  const col = colorFor(name);
  $('inc-avatar').style.background = col;
  $('inc-avatar').textContent = name[0].toUpperCase();
  $('inc-name').textContent = name;
  $('inc-type').textContent = callType === 'video' ? 'ğŸ“¹ Videochiamata in arrivo' :
                               callType === 'screen' ? 'ğŸ–¥ï¸ Condivisione schermo' : 'ğŸ“ Chiamata audio';
  showModal('incoming-overlay');
}

async function acceptCall() {
  hideModal('incoming-overlay');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: callType === 'video',
      audio: true
    });
    localStream = stream;
    $('local-video').srcObject = stream;
    currentCall.answer(stream);
    currentCall.on('stream', remoteStream => {
      $('remote-video').srcObject = remoteStream;
      $('remote-video').style.display = 'block';
      $('call-avatar').style.display = 'none';
      $('call-status').textContent = 'ğŸ”´ In chiamata';
    });
    currentCall.on('close', cleanupCall);
    const callerName = currentCall.metadata?.callerName || 'Contatto';
    showCallUI(callerName, callType, false);
  } catch(e) { toast('Errore nell\'accettare la chiamata'); }
}

function rejectCall() {
  currentCall && currentCall.close();
  currentCall = null;
  hideModal('incoming-overlay');
}

function showCallUI(name, type, isCaller) {
  const col = colorFor(name);
  $('call-avatar').style.background = col;
  $('call-avatar').textContent = name[0].toUpperCase();
  $('call-name').textContent = name;
  $('call-status').textContent = isCaller ? 'â³ In attesa...' : 'ğŸ”´ In chiamata';
  $('filter-bar').classList.toggle('hidden', type === 'audio');
  $('call-overlay').classList.remove('hidden');
  // Timer durata
  let sec = 0;
  callTimer = setInterval(() => {
    sec++;
    const m = String(Math.floor(sec/60)).padStart(2,'0'), s = String(sec%60).padStart(2,'0');
    $('call-label').textContent = `ğŸ”’ ${m}:${s} Â· WebRTC E2E`;
  }, 1000);
}

function endCall() {
  currentCall && currentCall.close();
  cleanupCall();
}

function cleanupCall() {
  clearInterval(callTimer);
  localStream && localStream.getTracks().forEach(t => t.stop());
  localStream = null;
  $('remote-video').srcObject = null;
  $('local-video').srcObject = null;
  $('remote-video').style.display = 'none';
  $('local-video').style.display = 'none';
  $('call-avatar').style.display = 'flex';
  $('call-overlay').classList.add('hidden');
  $('call-overlay').classList.remove('pip-mode');
  isPiP = false; isMuted = false; isCamOff = false;
  $('btn-mute').textContent = 'ğŸ¤'; $('btn-cam').textContent = 'ğŸ“·';
}

function toggleMute() {
  if (!localStream) return;
  isMuted = !isMuted;
  localStream.getAudioTracks().forEach(t => t.enabled = !isMuted);
  $('btn-mute').textContent = isMuted ? 'ğŸ”‡' : 'ğŸ¤';
  $('btn-mute').classList.toggle('active', isMuted);
}

function toggleCamera() {
  if (!localStream) return;
  isCamOff = !isCamOff;
  localStream.getVideoTracks().forEach(t => t.enabled = !isCamOff);
  $('btn-cam').textContent = isCamOff ? 'ğŸš«' : 'ğŸ“·';
  $('btn-cam').classList.toggle('active', isCamOff);
}

function toggleSpeaker() { toast('Altoparlante: funzione dipende dal dispositivo'); }

function toggleFilters() {
  $('filter-bar').classList.toggle('hidden');
}

function applyFilter(filter, btn) {
  $('remote-video').style.filter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

/* Picture-in-Picture */
function togglePiP() {
  isPiP = !isPiP;
  $('call-overlay').classList.toggle('pip-mode', isPiP);
  $('btn-pip').classList.toggle('active', isPiP);
  if (isPiP) {
    makeDraggable($('call-overlay'));
    toast('ğŸ’¡ Trascina la finestra dove vuoi');
  }
}

function makeDraggable(el) {
  el.onmousedown = e => {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'VIDEO') return;
    let ox = e.clientX - el.getBoundingClientRect().left, oy = e.clientY - el.getBoundingClientRect().top;
    document.onmousemove = ev => {
      el.style.left = (ev.clientX - ox) + 'px'; el.style.top = (ev.clientY - oy) + 'px';
      el.style.bottom = 'auto'; el.style.right = 'auto';
    };
    document.onmouseup = () => { document.onmousemove = null; document.onmouseup = null; };
  };
  // Touch drag
  el.ontouchstart = e => {
    const t = e.touches[0];
    let ox = t.clientX - el.getBoundingClientRect().left, oy = t.clientY - el.getBoundingClientRect().top;
    el.ontouchmove = ev => {
      const tt = ev.touches[0];
      el.style.left = (tt.clientX - ox) + 'px'; el.style.top = (tt.clientY - oy) + 'px';
      el.style.bottom = 'auto'; el.style.right = 'auto';
    };
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WALLET / YOULI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateBalUI() {
  const b = (currentUser.balance || 0).toFixed(2);
  $('bal-val').textContent = b;
}

function showWalletModal() {
  $('wallet-modal-bal').textContent = (currentUser.balance || 0).toFixed(2);
  $('redeem-result').style.display = 'none';
  $('code-input').value = '';
  $('code-feedback').textContent = '';
  $('code-feedback').style.color = '';
  renderRedeemHistory();
  showModal('wallet-overlay');
}

/* â”€â”€ CODICI YOULINIRI UFFICIALI â”€â”€ */
const YOULINIRI_CODES = {
  "5329HL7614a646hN593": 5,
  "75nC639hH1L2M2NA":    5,
  "43510Npy462A598317d": 10
};

function resetCodeFeedback() {
  $('code-feedback').textContent = '';
  $('code-feedback').style.color = '';
}

function redeemCode() {
  const raw = $('code-input').value.trim();
  const fb  = $('code-feedback');

  if (!raw) {
    fb.textContent = 'âš  Inserisci un codice';
    fb.style.color = 'var(--orange)';
    return;
  }

  // â”€â”€ 1. Controlla se giÃ  usato â”€â”€
  const usedCodes = LS.get('yl_used_codes') || [];
  if (usedCodes.includes(raw)) {
    fb.textContent = 'âœ• Codice giÃ  utilizzato';
    fb.style.color = 'var(--red)';
    return;
  }

  let value = null;
  let sourceLabel = '';

  // â”€â”€ 2. Codici YOULINIRI ufficiali â”€â”€
  if (YOULINIRI_CODES[raw] !== undefined) {
    value = YOULINIRI_CODES[raw];
    sourceLabel = 'Codice YOULINIRI';
  }

  // â”€â”€ 3. Voucher YLN-* generati dall'app â”€â”€
  if (value === null) {
    const vault = LS.get('yl_voucher_vault') || {};
    const entry = vault[raw];
    if (entry && !entry.used) {
      value = entry.value;
      sourceLabel = 'Voucher YLN';
      // Segna come usato nel vault
      entry.used = true;
      entry.usedBy = currentUser.username;
      entry.usedAt = new Date().toISOString();
      vault[raw] = entry;
      LS.set('yl_voucher_vault', vault);
    } else if (entry && entry.used) {
      fb.textContent = 'âœ• Voucher giÃ  riscattato';
      fb.style.color = 'var(--red)';
      return;
    }
  }

  // â”€â”€ 4. Non trovato â”€â”€
  if (value === null) {
    fb.textContent = 'âœ• Codice non valido';
    fb.style.color = 'var(--red)';
    $('code-input').style.animation = 'none';
    $('code-input').offsetHeight;
    $('code-input').style.animation = 'shake .3s ease';
    return;
  }

  // â”€â”€ 5. Accredita â”€â”€
  currentUser.balance = parseFloat(((currentUser.balance || 0) + value).toFixed(2));
  if (!currentUser.redemptions) currentUser.redemptions = [];
  currentUser.redemptions.push({
    code:   raw,
    amount: '+' + parseFloat(value).toFixed(2),
    date:   new Date().toLocaleDateString('it-IT'),
    type:   'IN',
    source: sourceLabel
  });
  usedCodes.push(raw);
  LS.set('yl_used_codes', usedCodes);

  saveUser();
  updateBalUI();
  $('wallet-modal-bal').textContent = currentUser.balance.toFixed(2);
  $('code-input').value = '';

  fb.textContent = `âœ“ +${parseFloat(value).toFixed(2)} YOULI accreditati!`;
  fb.style.color = 'var(--green)';
  renderRedeemHistory();
  toast(`ğŸª™ +${parseFloat(value).toFixed(2)} YOULI aggiunti al saldo!`, 3000);
}

function genYouliCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const seg = n => Array.from({length:n}, ()=>chars[Math.random()*chars.length|0]).join('');
  return `YLN-${seg(4)}-${seg(4)}-${seg(4)}-${seg(4)}`;
}

function riscattaYouli() {
  const bal = currentUser.balance || 0;
  if (bal < 1.0) { toast('âš  Minimo 1.00 YOULI per riscattare'); return; }
  const code = genYouliCode();
  const amount = parseFloat(bal.toFixed(2));

  // Salva nel vault globale cosÃ¬ puÃ² essere riscattato con "Inserisci Codice"
  const vault = LS.get('yl_voucher_vault') || {};
  vault[code] = { value: amount, createdBy: currentUser.username, used: false };
  LS.set('yl_voucher_vault', vault);

  if (!currentUser.redemptions) currentUser.redemptions = [];
  currentUser.redemptions.push({ code, amount: amount.toFixed(2), date: new Date().toLocaleDateString('it-IT'), type: 'OUT' });
  currentUser.balance = 0;
  saveUser(); updateBalUI();
  $('wallet-modal-bal').textContent = '0.00';
  $('redeem-code-display').textContent = code;
  $('redeem-result').style.display = 'block';
  renderRedeemHistory();
  toast('ğŸ‰ Voucher creato! Riscattalo quando vuoi dalla sezione codici.');
  if (activeContact) {
    sendPayload({ type:'text', content:`ğŸª™ Voucher YOULI: ${code} (${amount.toFixed(2)} YL)` });
  }
}

function copyRedeemCode() {
  navigator.clipboard.writeText($('redeem-code-display').textContent).then(() => toast('ğŸ“‹ Codice copiato!'));
}

function renderRedeemHistory() {
  const hist = $('redeem-history');
  const reds = currentUser.redemptions || [];
  if (reds.length === 0) {
    hist.innerHTML = '<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px">Nessuna operazione ancora</div>';
    return;
  }
  hist.innerHTML = [...reds].reverse().map(r => {
    const isIn = r.type === 'IN' || String(r.amount).startsWith('+');
    return `
    <div class="history-item">
      <div>
        <div class="code">${escHtml(r.code)}</div>
        <div style="color:var(--text3);font-size:10px">${r.date} Â· ${isIn ? 'ğŸŸ Codice' : 'ğŸ’° Conversione'}</div>
      </div>
      <div class="amount" style="color:${isIn ? 'var(--green)' : 'var(--youli)'}">
        ${isIn ? '' : '-'}${String(r.amount).replace(/^-/,'')} YL
      </div>
    </div>`;
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SNAKE GAME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let snakeLoop, snakePos, snakeDir, snakeFood, snakeScore = 0, snakeEarned = 0;
const SGRID = 14; // celle

function openSnakeModal() {
  showModal('snake-overlay');
  if ($('attach-menu')) $('attach-menu').classList.add('hidden');
  snakeScore = 0; snakeEarned = 0;
  $('snake-score').textContent = 0;
  $('snake-youli').textContent = '+0.00';
  initSnake();
}

function initSnake() {
  clearInterval(snakeLoop);
  const c = $('sCanvas'), ctx = c.getContext('2d');
  const SIZE = c.width / SGRID;
  snakePos = [{x:7,y:7}]; snakeDir = 'R';
  snakeFood = randFood();

  snakeLoop = setInterval(() => {
    ctx.fillStyle = '#0a0a1a'; ctx.fillRect(0,0,c.width,c.height);
    // Draw grid
    ctx.strokeStyle = 'rgba(255,255,255,.03)';
    for(let i=0;i<SGRID;i++){for(let j=0;j<SGRID;j++){ctx.strokeRect(i*SIZE,j*SIZE,SIZE,SIZE);}}
    // Food
    ctx.fillStyle = '#ff3b30';
    ctx.beginPath(); ctx.arc(snakeFood.x*SIZE+SIZE/2, snakeFood.y*SIZE+SIZE/2, SIZE/2-1, 0, Math.PI*2); ctx.fill();
    // Snake
    snakePos.forEach((p,i) => {
      const g = ctx.createLinearGradient(p.x*SIZE,p.y*SIZE,p.x*SIZE+SIZE,p.y*SIZE+SIZE);
      g.addColorStop(0,'#007aff'); g.addColorStop(1,'#00c6ff');
      ctx.fillStyle = i===0 ? '#34c759' : g;
      ctx.beginPath(); ctx.roundRect(p.x*SIZE+1,p.y*SIZE+1,SIZE-2,SIZE-2,4); ctx.fill();
    });
    // Move
    let h = {...snakePos[0]};
    if(snakeDir==='R') h.x++; if(snakeDir==='L') h.x--;
    if(snakeDir==='U') h.y--; if(snakeDir==='D') h.y++;
    // Wrap
    h.x=(h.x+SGRID)%SGRID; h.y=(h.y+SGRID)%SGRID;
    // Eat
    if(h.x===snakeFood.x && h.y===snakeFood.y) {
      snakeScore++; snakeEarned = parseFloat((snakeEarned+0.1).toFixed(2));
      currentUser.balance = parseFloat(((currentUser.balance||0)+0.1).toFixed(2));
      saveUser(); updateBalUI();
      $('snake-score').textContent = snakeScore;
      $('snake-youli').textContent = '+'+snakeEarned.toFixed(2);
      snakeFood = randFood();
    } else { snakePos.pop(); }
    // Self collision
    if(snakePos.some(p=>p.x===h.x&&p.y===h.y)){ clearInterval(snakeLoop); toast('ğŸ’€ Game Over! +'+snakeEarned.toFixed(2)+' YL'); return; }
    snakePos.unshift(h);
  }, 130);
}

function randFood() {
  return {x:Math.floor(Math.random()*SGRID), y:Math.floor(Math.random()*SGRID)};
}

function snakeKeyHandler(e) {
  if(!$('snake-overlay').classList.contains('hidden')) {
    const map={'ArrowUp':'U','ArrowDown':'D','ArrowLeft':'L','ArrowRight':'R'};
    const opp={'U':'D','D':'U','L':'R','R':'L'};
    const nd=map[e.key];
    if(nd && opp[nd]!==snakeDir){snakeDir=nd;e.preventDefault();}
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function colorFor(name) {
  const colors=['#007aff','#34c759','#ff9500','#ff3b30','#af52de','#ff2d55','#5ac8fa','#ff6b35'];
  let h=0; for(const c of (name||'?')) h=(h*31+c.charCodeAt(0))&0xffff;
  return colors[h%colors.length];
}

function escHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function fmtTime(d) {
  return d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
}

function exportData() {
  const data = { user: currentUser, contacts, messages: chatMessages };
  const b = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(b);
  a.download = 'youliniri_backup.json'; a.click();
  toast('ğŸ“¤ Dati esportati');
}

function resetApp() {
  if(!confirm('ATTENZIONE: Tutti i dati verranno eliminati. Continuare?')) return;
  localStorage.clear();
  document.cookie.split(';').forEach(c => { delCookie(c.split('=')[0].trim()); });
  location.reload();
}

function showChatMenu() { toast('Menu contestuale prossimamente!'); }
function showProfileModal() { toast('Profilo: ' + (currentUser?.name||'') + ' â€” ' + (currentUser?.username||'')); }

/* â”€â”€â”€ START â”€â”€â”€ */

  // â”€â”€ Seed codice utente esistente nel vault se non presente â”€â”€
  (function seedExistingCode() {
    const vault = LS.get('yl_voucher_vault') || {};
    // Il codice YLN-D3QV-GGR5-VYHQ-P3TN creato dall'utente va qui sotto con il suo valore
    // (sostituisci il valore con quello che avevi nel saldo prima di convertirlo)
    if (!vault['YLN-D3QV-GGR5-VYHQ-P3TN']) {
      vault['YLN-D3QV-GGR5-VYHQ-P3TN'] = { value: 1, createdBy: 'system', used: false };
      LS.set('yl_voucher_vault', vault);
    }
  })();
initPrivacy();
</script>
</body>
</html>