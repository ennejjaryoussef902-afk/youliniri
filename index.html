<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>YOULINIRI</title>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<style>
:root{
  --blue:#007aff;--blue2:#0055d4;--green:#34c759;--red:#ff3b30;
  --orange:#ff9500;--purple:#af52de;--youli:#f0c040;
  --bg:#f2f2f7;--bg2:#e5e5ea;--white:#fff;--text:#1c1c1e;--text2:#636366;--text3:#aeaeb2;
  --border:rgba(0,0,0,.08);--font:-apple-system,BlinkMacSystemFont,sans-serif;
  --sidebar-w:290px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:var(--font);background:var(--bg);color:var(--text)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--bg2);border-radius:2px}

/* OVERLAY */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);z-index:900;display:flex;align-items:center;justify-content:center;animation:fi .2s}
.overlay.hidden{display:none!important}
@keyframes fi{from{opacity:0}to{opacity:1}}
.mcard{background:#fff;border-radius:22px;padding:24px 20px;width:340px;max-width:95vw;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.25);animation:su .22s cubic-bezier(.34,1.56,.64,1)}
@keyframes su{from{opacity:0;transform:translateY(20px) scale(.97)}to{opacity:1;transform:none}}
.mtitle{font-size:18px;font-weight:700;margin-bottom:5px}
.msub{font-size:13px;color:var(--text2);line-height:1.5;margin-bottom:14px}

/* INPUTS */
.inp{width:100%;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;font-size:15px;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;transition:border .2s;-webkit-appearance:none}
.inp:focus{border-color:var(--blue)}
.inp-wrap{margin-bottom:11px}
.ilabel{display:block;font-size:11px;font-weight:700;color:var(--text2);letter-spacing:.4px;margin-bottom:4px}

/* BUTTONS */
.btn{padding:12px 18px;border:none;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s}
.btn:active{transform:scale(.96)}
.bp{background:var(--blue);color:#fff;width:100%}
.bp:hover{background:var(--blue2)}
.bg{background:transparent;color:var(--blue);width:100%;margin-top:5px}
.bd{background:var(--red);color:#fff;width:100%}
.bico{background:var(--bg2);border:none;width:40px;height:40px;border-radius:50%;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0}
.bico:hover{background:var(--bg)}
.bico.act{background:var(--blue);color:#fff}
.bico.red{background:var(--red);color:#fff}

/* AUTH */
.tabs{display:flex;background:var(--bg);border-radius:10px;padding:3px;margin-bottom:18px}
.tabb{flex:1;padding:7px;border:none;background:transparent;border-radius:7px;font-size:14px;font-weight:600;cursor:pointer;color:var(--text2);transition:.2s}
.tabb.act{background:#fff;color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.alogo{text-align:center;margin-bottom:18px}
.alogo-ico{font-size:44px;display:block;margin-bottom:6px}
.alogo h1{font-size:20px;font-weight:800;color:var(--blue);letter-spacing:.5px}
.alogo p{font-size:11px;color:var(--text3);letter-spacing:.5px;margin-top:2px}
#auth-err{color:var(--red);font-size:12px;text-align:center;margin-top:8px;min-height:16px}

/* PRIVACY */
.pbody{max-height:200px;overflow-y:auto;background:var(--bg);border-radius:10px;padding:12px;font-size:12px;line-height:1.7;color:var(--text2);margin-bottom:14px}
.pbody h4{color:var(--text);margin:8px 0 3px;font-size:12px}
.crow{display:flex;align-items:center;gap:9px;margin-bottom:9px;cursor:pointer;font-size:13px}
.crow input{width:17px;height:17px;accent-color:var(--blue);cursor:pointer}

/* APP LAYOUT */
#app{display:flex;height:100vh;width:100%;opacity:0;transition:opacity .3s}
#app.vis{opacity:1}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);min-width:var(--sidebar-w);background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column;height:100vh;transition:transform .25s;z-index:20}
.shdr{padding:14px;background:linear-gradient(135deg,#007aff,#0055d4);color:#fff;flex-shrink:0}
.merow{display:flex;align-items:center;gap:9px}
.av{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:17px;font-weight:700;flex-shrink:0;position:relative;cursor:pointer}
.avdot{position:absolute;bottom:0;right:0;width:10px;height:10px;background:var(--green);border-radius:50%;border:2px solid #007aff}
.mename{font-weight:700;font-size:14px}
.meid{font-size:10px;opacity:.7;font-family:monospace;margin-top:1px;display:flex;align-items:center;gap:5px;flex-wrap:wrap}
.cpbtn{font-size:9px;background:rgba(255,255,255,.2);border:none;color:#fff;padding:2px 6px;border-radius:20px;cursor:pointer;white-space:nowrap}

/* WALLET MINI */
.wcard{margin:10px;background:linear-gradient(135deg,#1c1c2e,#2d2d44);border-radius:14px;padding:12px;color:#fff;flex-shrink:0}
.wbal{font-size:26px;font-weight:900;color:var(--youli);line-height:1;margin:3px 0}
.wlbl{font-size:9px;letter-spacing:1px;opacity:.5;text-transform:uppercase}
.wacts{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:9px}
.wb{padding:7px;border:none;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;transition:.15s}
.wb.earn{background:rgba(240,192,64,.15);color:var(--youli);border:1px solid rgba(240,192,64,.3)}
.wb.red2{background:var(--youli);color:#1c1c1e}
.wb:hover{opacity:.85}

/* CONTACTS */
.slbl{font-size:10px;font-weight:700;color:var(--text3);letter-spacing:.7px;padding:8px 12px 3px;text-transform:uppercase;flex-shrink:0}
.clist{flex:1;overflow-y:auto;padding:3px 8px}
.ci{display:flex;align-items:center;gap:9px;padding:9px;border-radius:12px;cursor:pointer;transition:.15s;position:relative}
.ci:hover{background:var(--bg)}
.ci.act{background:#e8f0ff}
.cav{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:#fff;flex-shrink:0}
.cinfo{flex:1;min-width:0}
.cname{font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cprev{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ctime{font-size:10px;color:var(--text3);flex-shrink:0}
.odot{width:9px;height:9px;background:var(--green);border-radius:50%;border:2px solid #fff;position:absolute;bottom:7px;left:41px}

.sfooter{padding:8px;border-top:1px solid var(--border);display:flex;gap:6px;flex-shrink:0}
.sfooter .bico{flex:1;width:auto;border-radius:9px;font-size:14px}

/* CHAT MAIN */
.cmain{flex:1;display:flex;flex-direction:column;background:var(--bg);min-width:0;height:100vh}
.chdr{background:#fff;padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.chinfo{flex:1;min-width:0}
.chname{font-size:15px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chstatus{font-size:11px;color:var(--green)}
.chacts{display:flex;gap:6px}
.chacts .bico{width:36px;height:36px;font-size:15px}
.hamburger{display:none;background:none;border:none;font-size:22px;cursor:pointer;padding:4px;margin-right:4px}

/* MESSAGES */
#msgbox{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:8px}
.mwrap{display:flex;flex-direction:column;max-width:75%;animation:mpop .18s ease}
@keyframes mpop{from{opacity:0;transform:scale(.94) translateY(5px)}to{opacity:1;transform:none}}
.mwrap.me{align-self:flex-end;align-items:flex-end}
.mwrap.them{align-self:flex-start;align-items:flex-start}
.mauthor{font-size:10px;color:var(--text3);margin-bottom:2px;font-weight:600}
.bub{padding:9px 13px;border-radius:17px;font-size:14px;line-height:1.5;word-break:break-word}
.me .bub{background:var(--blue);color:#fff;border-bottom-right-radius:4px}
.them .bub{background:#fff;color:var(--text);border-bottom-left-radius:4px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.mtime{font-size:10px;color:var(--text3);margin-top:2px;padding:0 3px}
.daydiv{text-align:center;font-size:11px;color:var(--text3);margin:4px 0}
.daydiv span{background:var(--bg);padding:2px 9px;border-radius:20px}
/* file bubble */
.fbub{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:17px;max-width:230px;cursor:pointer;text-decoration:none}
.me .fbub{background:#0055d4}
.them .fbub{background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.ficon{font-size:26px;flex-shrink:0}
.fname{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
.fsize{font-size:10px;opacity:.7}
.me .fname,.me .fsize{color:#fff}
.them .fname{color:var(--text)}
/* audio bubble */
.abub{display:flex;align-items:center;gap:7px;padding:8px 11px;border-radius:17px;min-width:160px}
.me .abub{background:#0055d4}
.them .abub{background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.06)}
.aplay{width:34px;height:34px;border-radius:50%;border:none;font-size:13px;cursor:pointer;flex-shrink:0}
.me .aplay{background:rgba(255,255,255,.2);color:#fff}
.them .aplay{background:var(--blue);color:#fff}
.adur{font-size:10px;opacity:.7}
.me .adur{color:#fff}
/* poll */
.pbub{padding:11px;min-width:190px;max-width:270px;border-radius:17px}
.pq{font-weight:700;margin-bottom:9px;font-size:13px}
.popt{padding:7px 11px;border-radius:8px;margin-bottom:5px;cursor:pointer;font-size:12px;border:none;width:100%;text-align:left;transition:.15s}
.me .popt{background:rgba(255,255,255,.2);color:#fff}
.me .popt:hover{background:rgba(255,255,255,.3)}
.them .popt{background:var(--bg);color:var(--text)}
.them .popt:hover{background:var(--bg2)}
/* youli gift */
.ygift{background:linear-gradient(135deg,#1c1c2e,#2d2d44);border-radius:16px;padding:13px;color:#fff;text-align:center;min-width:180px}
.yamount{font-size:22px;font-weight:900;color:var(--youli)}
.ycode{font-family:monospace;font-size:10px;background:rgba(240,192,64,.15);padding:5px;border-radius:6px;margin-top:7px;color:var(--youli);word-break:break-all}
/* group badge */
.gbadge{display:inline-block;font-size:10px;background:var(--purple);color:#fff;padding:1px 6px;border-radius:20px;margin-left:5px;vertical-align:middle}

/* INPUT BAR */
.ibar{background:#fff;border-top:1px solid var(--border);padding:8px 10px;display:flex;align-items:flex-end;gap:7px;flex-shrink:0}
#msginput{flex:1;border:1.5px solid var(--border);border-radius:20px;padding:9px 14px;font-size:15px;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;resize:none;max-height:110px;overflow-y:auto;line-height:1.4;transition:border .2s;-webkit-appearance:none}
#msginput:focus{border-color:var(--blue)}
.sendbtn{width:42px;height:42px;border-radius:50%;background:var(--blue);border:none;color:#fff;font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:.15s}
.sendbtn:hover{background:var(--blue2)}
.sendbtn:active{transform:scale(.91)}

/* ATTACH MENU */
.amenu{background:#fff;border-top:1px solid var(--border);padding:10px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;flex-shrink:0}
.amenu.hidden{display:none}
.aitem{cursor:pointer;text-align:center;padding:7px;border-radius:11px;transition:.15s}
.aitem:hover{background:var(--bg)}
.aicon{font-size:26px;display:block;margin-bottom:3px}
.alabel{font-size:10px;font-weight:600;color:var(--text2)}

/* RECORDING BAR */
.recbar{background:#fff;border-top:1px solid var(--border);padding:12px 14px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.recbar.hidden{display:none}
.recind{width:10px;height:10px;border-radius:50%;background:var(--red);animation:bl 1s infinite;flex-shrink:0}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.2}}
.rectime{font-family:monospace;font-size:17px;font-weight:700;flex:1}
.recwave{flex:2;height:28px;display:flex;align-items:center;gap:2px;overflow:hidden}
.recwave span{width:2px;border-radius:1px;background:var(--blue);animation:wv 1s ease-in-out infinite;flex-shrink:0;min-height:4px}
.recwave span:nth-child(even){animation-delay:.15s;height:55%!important}
.recwave span:nth-child(3n){animation-delay:.3s}
@keyframes wv{0%,100%{transform:scaleY(1)}50%{transform:scaleY(2)}}

/* NO CHAT */
.nochat{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);gap:9px}
.nochat-ico{font-size:60px}

/* CONNECTION STATUS */
.connstatus{font-size:10px;padding:3px 8px;border-radius:20px;font-weight:600;display:inline-flex;align-items:center;gap:4px}
.connstatus.online{background:rgba(52,199,89,.15);color:var(--green)}
.connstatus.offline{background:rgba(255,59,48,.1);color:var(--red)}
.connstatus.connecting{background:rgba(0,122,255,.1);color:var(--blue)}

/* ‚ïê‚ïê‚ïê‚ïê CALL OVERLAY ‚ïê‚ïê‚ïê‚ïê */
#callover{position:fixed;inset:0;background:#0a0a0a;z-index:800;display:flex;flex-direction:column;align-items:center;justify-content:center}
#callover.hidden{display:none}
#callover.pip{position:fixed;bottom:16px;right:16px;inset:auto;width:300px;height:210px;border-radius:18px;overflow:hidden;z-index:1000;box-shadow:0 8px 40px rgba(0,0,0,.5);cursor:grab}
#callover.pip:active{cursor:grabbing}
#remotev{width:100%;height:100%;object-fit:cover;position:absolute;inset:0;display:none}
#localv{position:absolute;bottom:70px;right:12px;width:100px;height:75px;border-radius:12px;object-fit:cover;border:2px solid rgba(255,255,255,.3);z-index:2;display:none}
#callover.pip #localv{width:65px;height:48px;bottom:44px;right:7px}
.callbg{position:absolute;inset:0;background:radial-gradient(ellipse at center,#1a1a2e,#0a0a0a)}
.callav{width:90px;height:90px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;color:#fff;margin-bottom:14px;position:relative;z-index:2;border:3px solid rgba(255,255,255,.2)}
.callav::after{content:"";position:absolute;inset:-7px;border-radius:50%;border:2px solid rgba(255,255,255,.12);animation:rp 2s infinite}
@keyframes rp{0%{transform:scale(1);opacity:1}100%{transform:scale(1.4);opacity:0}}
.callinfo{position:relative;z-index:2;text-align:center;color:#fff;margin-bottom:18px}
.callinfo h2{font-size:24px;font-weight:700}
.callinfo p{font-size:13px;opacity:.65;margin-top:5px}
#calllbl{font-size:11px;color:rgba(255,255,255,.4);font-family:monospace;margin-top:3px}
.callctrl{display:flex;gap:10px;position:relative;z-index:2;padding:14px 18px;background:rgba(0,0,0,.4);border-radius:28px;backdrop-filter:blur(10px)}
.callctrl .bico{width:48px;height:48px;font-size:20px}
#callover.pip .callctrl{padding:6px 8px;gap:6px;border-radius:20px}
#callover.pip .callctrl .bico{width:32px;height:32px;font-size:14px}
#callover.pip .callinfo,.callover.pip #calllbl{display:none}
#filterbar{position:absolute;top:14px;left:0;right:0;display:flex;justify-content:center;gap:7px;z-index:3;flex-wrap:wrap;padding:0 10px}
#filterbar.hidden{display:none}
.fbtn{padding:5px 11px;border-radius:18px;border:1.5px solid rgba(255,255,255,.25);background:rgba(0,0,0,.45);color:#fff;font-size:11px;cursor:pointer;backdrop-filter:blur(6px);transition:.15s}
.fbtn:hover,.fbtn.act{background:rgba(255,255,255,.18);border-color:#fff}

/* INCOMING CALL */
#incall .mcard{text-align:center}
.incav{width:72px;height:72px;border-radius:50%;margin:0 auto 10px;display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700;color:#fff}
.inacts{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}

/* WALLET MODAL */
.ycodeshow{font-family:monospace;font-size:14px;letter-spacing:2px;background:linear-gradient(135deg,#1c1c2e,#2d2d44);color:var(--youli);padding:12px;border-radius:11px;text-align:center;margin:12px 0;user-select:all;word-break:break-all}
.hitem{padding:7px;border-radius:8px;background:var(--bg);margin-bottom:5px;font-size:11px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.hcode{font-family:monospace;color:var(--text);font-size:10px;word-break:break-all;flex:1}
.hamount{font-weight:700;color:var(--youli);white-space:nowrap}
.hamount.in{color:var(--green)}

/* CODE INPUT */
.cinpbox{background:linear-gradient(135deg,rgba(240,192,64,.07),rgba(240,192,64,.02));border:1.5px solid rgba(240,192,64,.22);border-radius:13px;padding:13px;margin-bottom:12px}
.cinprow{display:flex;gap:7px;align-items:center}
.cinprow .inp{flex:1;font-family:monospace;font-size:12px;letter-spacing:.4px;margin:0}
.cbtn{background:var(--youli);border:none;border-radius:9px;padding:9px 12px;font-weight:700;font-size:12px;cursor:pointer;color:#1c1c1e;white-space:nowrap;flex-shrink:0}
#codefb{font-size:11px;margin-top:7px;min-height:15px;font-family:monospace;text-align:center}

/* GROUP MODAL */
.gm-members{max-height:180px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;padding:6px;margin-bottom:10px}
.gm-member{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;cursor:pointer;transition:.15s}
.gm-member:hover{background:var(--bg)}
.gm-member input[type=checkbox]{accent-color:var(--blue);width:16px;height:16px}

/* TOAST */
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:rgba(28,28,30,.9);color:#fff;padding:9px 18px;border-radius:20px;font-size:13px;font-weight:500;z-index:9999;backdrop-filter:blur(10px);pointer-events:none;opacity:0;transition:opacity .3s;white-space:nowrap;max-width:90vw;text-align:center}
#toast.show{opacity:1}

/* SNAKE */
#sCanvas{border-radius:12px;display:block;margin:0 auto;touch-action:none}
.snakestats{display:flex;justify-content:space-between;margin-bottom:9px;font-size:13px;font-weight:600}

/* SHAKE ANIM */
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-5px)}40%{transform:translateX(5px)}60%{transform:translateX(-3px)}80%{transform:translateX(3px)}}

/* DIVIDER */
hr.div{border:none;border-top:1px solid var(--border);margin:13px 0}

/* ‚îÄ‚îÄ RESPONSIVE MOBILE ‚îÄ‚îÄ */
@media(max-width:640px){
  :root{--sidebar-w:100vw}
  .sidebar{position:fixed;left:0;top:0;bottom:0;transform:translateX(-100%);width:100vw;z-index:100;box-shadow:4px 0 20px rgba(0,0,0,.15)}
  .sidebar.open{transform:translateX(0)}
  .hamburger{display:flex!important;align-items:center;justify-content:center}
  .chacts .bico{width:32px;height:32px;font-size:13px}
  .mwrap{max-width:86%}
  .bub{font-size:14px}
  #msginput{font-size:16px}
  .wbal{font-size:22px}
  .amenu{grid-template-columns:repeat(4,1fr);gap:6px}
  #callover.pip{width:240px;height:170px;bottom:12px;right:12px}
  .callctrl .bico{width:44px;height:44px;font-size:18px}
}
</style>
</head>
<body>
<div id="toast"></div>

<!-- PRIVACY -->
<div class="overlay" id="priv-ov">
  <div class="mcard">
    <div style="text-align:center;font-size:38px;margin-bottom:9px">üîê</div>
    <div class="mtitle" style="text-align:center">Privacy & Termini</div>
    <div class="msub" style="text-align:center">Leggi e accetta prima di continuare</div>
    <div class="pbody">
      <h4>1. Dati & Privacy</h4>Le comunicazioni sono peer-to-peer cifrate via WebRTC. Account e saldo vengono sincronizzati sul server locale che hai avviato.
      <h4>2. Messaggi</h4>I messaggi transitano direttamente tra dispositivi. Non esistono server di messaggi centralizzati.
      <h4>3. Valuta YOULI</h4>YOULI √® una valuta virtuale a scopo ludico senza valore monetario reale.
      <h4>4. Login multi-device</h4>Puoi accedere dallo stesso account su pi√π dispositivi purch√© il server Python sia raggiungibile.
      <h4>5. Cookie & Storage</h4>Usiamo cookie e localStorage solo per la sessione di login.
      <h4>6. Et√† minima</h4>Devi avere almeno 13 anni.
    </div>
    <label class="crow"><input type="checkbox" id="chk1"/> Accetto la Privacy Policy</label>
    <label class="crow"><input type="checkbox" id="chk2"/> Accetto i Termini di Servizio</label>
    <button class="btn bp" id="priv-btn" disabled>ACCETTA E CONTINUA</button>
  </div>
</div>

<!-- AUTH -->
<div class="overlay hidden" id="auth-ov">
  <div class="mcard">
    <div class="alogo">
      <span class="alogo-ico">üí¨</span>
      <h1>YOULINIRI PRO</h1>
      <p>CHAT ¬∑ CALL ¬∑ EARN YOULI</p>
    </div>
    <div class="tabs">
      <button class="tabb act" id="tl" onclick="stab('l')">Accedi</button>
      <button class="tabb" id="ts" onclick="stab('s')">Registrati</button>
    </div>
    <!-- LOGIN -->
    <div id="lform">
      <div class="inp-wrap"><label class="ilabel">NOME UTENTE</label><input class="inp" id="l-u" placeholder="username" autocomplete="username"/></div>
      <div class="inp-wrap"><label class="ilabel">PASSWORD</label><input class="inp" id="l-p" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()"/></div>
      <button class="btn bp" onclick="doLogin()">ACCEDI</button>
      <button class="btn bg" onclick="stab('s')">Non hai un account? Registrati</button>
    </div>
    <!-- SIGNUP -->
    <div id="sform" style="display:none">
      <div class="inp-wrap"><label class="ilabel">NOME COMPLETO</label><input class="inp" id="s-n" placeholder="Mario Rossi" autocomplete="name"/></div>
      <div class="inp-wrap"><label class="ilabel">USERNAME</label><input class="inp" id="s-u" placeholder="mario_rossi" autocomplete="username"/></div>
      <div class="inp-wrap"><label class="ilabel">PASSWORD</label><input class="inp" id="s-p" type="password" placeholder="Min. 6 caratteri" autocomplete="new-password"/></div>
      <div class="inp-wrap"><label class="ilabel">CONFERMA</label><input class="inp" id="s-p2" type="password" placeholder="Ripeti password" autocomplete="new-password" onkeydown="if(event.key==='Enter')doSignup()"/></div>
      <button class="btn bp" onclick="doSignup()">CREA ACCOUNT</button>
      <button class="btn bg" onclick="stab('l')">Hai gi√† un account? Accedi</button>
    </div>
    <div id="auth-err"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="shdr">
      <div class="merow">
        <div class="av" id="myav"><span id="myavl">?</span><div class="avdot" id="peerdot"></div></div>
        <div style="flex:1;min-width:0">
          <div class="mename" id="myname">---</div>
          <div class="meid">
            <span id="mypeerid" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px">connessione...</span>
            <button class="cpbtn" onclick="copyID()">copia</button>
          </div>
          <div style="margin-top:4px" id="connbadge"></div>
        </div>
      </div>
    </div>
    <div class="wcard">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><div class="wlbl">Saldo YOULI</div><div class="wbal" id="balval">0.00</div><div style="font-size:9px;opacity:.4;color:#fff">TOKEN VIRTUALI</div></div>
        <div style="font-size:26px">ü™ô</div>
      </div>
      <div class="wacts">
        <button class="wb earn" onclick="openSnake()">üêç Guadagna</button>
        <button class="wb red2" onclick="showWallet()">üí∞ Portafoglio</button>
      </div>
    </div>
    <div class="slbl">Conversazioni</div>
    <div class="clist" id="clist"><div style="text-align:center;padding:28px;color:var(--text3);font-size:13px">Nessun contatto.<br/>Aggiungine uno!</div></div>
    <div class="sfooter">
      <button class="bico" title="Aggiungi contatto" onclick="showM('addcont-ov')">‚ûï</button>
      <button class="bico" title="Nuovo gruppo" onclick="showM('group-ov')">üë•</button>
      <button class="bico" title="Impostazioni" onclick="showM('sett-ov')">‚öôÔ∏è</button>
      <button class="bico" title="Logout" onclick="doLogout()">üö™</button>
    </div>
  </aside>

  <!-- CHAT MAIN -->
  <div class="cmain" id="cmain">
    <!-- NO CHAT -->
    <div class="nochat" id="nochat">
      <div class="nochat-ico">üí¨</div>
      <h3 style="font-size:17px;font-weight:600;color:var(--text2)">Seleziona una conversazione</h3>
      <p style="font-size:13px;color:var(--text3)">o aggiungi un contatto</p>
    </div>
    <!-- ACTIVE CHAT -->
    <div id="activechat" style="display:none;flex-direction:column;height:100%">
      <div class="chdr">
        <button class="hamburger" id="hbtn" onclick="toggleSidebar()">‚ò∞</button>
        <div class="cav" id="chhav" style="width:36px;height:36px;font-size:15px;flex-shrink:0">?</div>
        <div class="chinfo">
          <div class="chname" id="chname">---</div>
          <div class="chstatus" id="chstatus">‚óè online</div>
        </div>
        <div class="chacts">
          <button class="bico" title="Chiamata audio" onclick="startCall('audio')">üìû</button>
          <button class="bico" title="Videochiamata" onclick="startCall('video')">üìπ</button>
          <button class="bico" title="Schermo" onclick="startCall('screen')">üñ•Ô∏è</button>
        </div>
      </div>
      <div id="msgbox"></div>
      <!-- RECORDING BAR -->
      <div class="recbar hidden" id="recbar">
        <div class="recind"></div>
        <div class="rectime" id="rectime">0:00</div>
        <div class="recwave">
          <span style="height:35%"></span><span style="height:75%"></span><span style="height:50%"></span>
          <span style="height:90%"></span><span style="height:40%"></span><span style="height:70%"></span>
          <span style="height:55%"></span><span style="height:85%"></span>
        </div>
        <button class="bico red" onclick="stopRec(true)">‚úï</button>
        <button class="bico act" onclick="stopRec(false)">‚úì</button>
      </div>
      <!-- ATTACH MENU -->
      <div class="amenu hidden" id="amenu">
        <div class="aitem" onclick="trigF('')"><span class="aicon">üìÅ</span><span class="alabel">File</span></div>
        <div class="aitem" onclick="trigF('image/*')"><span class="aicon">üñºÔ∏è</span><span class="alabel">Foto</span></div>
        <div class="aitem" onclick="trigF('video/*')"><span class="aicon">üé¨</span><span class="alabel">Video</span></div>
        <div class="aitem" onclick="trigF('audio/*')"><span class="aicon">üéµ</span><span class="alabel">Audio</span></div>
        <div class="aitem" onclick="sendLoc()"><span class="aicon">üìç</span><span class="alabel">Posizione</span></div>
        <div class="aitem" onclick="showM('poll-ov')"><span class="aicon">üìä</span><span class="alabel">Sondaggio</span></div>
        <div class="aitem" onclick="sendYouliGift()"><span class="aicon">ü™ô</span><span class="alabel">YOULI</span></div>
        <div class="aitem" onclick="openSnake()"><span class="aicon">üêç</span><span class="alabel">Snake</span></div>
      </div>
      <input type="file" id="finput" hidden onchange="handleFile(this)"/>
      <div class="ibar">
        <button class="bico" onclick="togAmenu()" id="abtn">‚ûï</button>
        <button class="bico" id="recbtn" onclick="togRec()">üéôÔ∏è</button>
        <textarea id="msginput" placeholder="Messaggio..." rows="1" onkeydown="msgKey(event)" oninput="autoR(this)"></textarea>
        <button class="sendbtn" onclick="sendText()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- CALL OVERLAY -->
<div id="callover" class="hidden">
  <div class="callbg"></div>
  <video id="remotev" autoplay playsinline></video>
  <video id="localv" autoplay playsinline muted></video>
  <div id="filterbar" class="hidden">
    <button class="fbtn act" onclick="applyF('none',this)">Normale</button>
    <button class="fbtn" onclick="applyF('grayscale(1)',this)">B&N</button>
    <button class="fbtn" onclick="applyF('sepia(1)',this)">Vintage</button>
    <button class="fbtn" onclick="applyF('hue-rotate(90deg) saturate(2)',this)">Neon</button>
    <button class="fbtn" onclick="applyF('invert(.8) hue-rotate(180deg)',this)">Matrix</button>
  </div>
  <div class="callav" id="callav">?</div>
  <div class="callinfo"><h2 id="callname">---</h2><p id="callst">In attesa...</p></div>
  <div id="calllbl">üîí WebRTC E2E</div>
  <div class="callctrl">
    <button class="bico" id="bmute" onclick="togMute()">üé§</button>
    <button class="bico" id="bcam" onclick="togCam()">üì∑</button>
    <button class="bico" id="bspk" onclick="toast('Altoparlante OS')">üîä</button>
    <button class="bico" id="bfilt" onclick="togFilters()">‚ú®</button>
    <button class="bico" id="bpip" onclick="togPiP()" title="Picture in Picture ‚Äî trascina ovunque">‚õ∂</button>
    <button class="bico red" onclick="endCall()">üìµ</button>
  </div>
</div>

<!-- INCOMING CALL -->
<div class="overlay hidden" id="incall">
  <div class="mcard">
    <div class="incav" id="incav">?</div>
    <div style="font-size:17px;font-weight:700;text-align:center" id="incname">---</div>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin:6px 0" id="inctype">üìû Chiamata</div>
    <div class="inacts">
      <button class="btn bd" style="padding:10px" onclick="rejCall()">‚úï Rifiuta</button>
      <button class="btn" style="padding:10px;background:var(--green);color:#fff" onclick="accCall()">‚úì Rispondi</button>
    </div>
  </div>
</div>

<!-- ADD CONTACT -->
<div class="overlay hidden" id="addcont-ov">
  <div class="mcard">
    <div class="mtitle">‚ûï Nuovo Contatto</div>
    <div class="msub">Aggiungi un amico tramite il suo ID</div>
    <div class="inp-wrap"><label class="ilabel">NOME</label><input class="inp" id="fc-n" placeholder="Nome contatto"/></div>
    <div class="inp-wrap"><label class="ilabel">ID PEER</label><input class="inp" id="fc-i" placeholder="yln_username"/></div>
    <button class="btn bp" onclick="addCont()">AGGIUNGI</button>
    <button class="btn bg" onclick="hideM('addcont-ov')">Annulla</button>
  </div>
</div>

<!-- GROUP CREATE -->
<div class="overlay hidden" id="group-ov">
  <div class="mcard">
    <div class="mtitle">üë• Nuovo Gruppo</div>
    <div class="inp-wrap"><label class="ilabel">NOME GRUPPO</label><input class="inp" id="g-n" placeholder="Nome del gruppo"/></div>
    <div class="inp-wrap"><label class="ilabel">SELEZIONA MEMBRI</label></div>
    <div class="gm-members" id="gmembers"></div>
    <button class="btn bp" onclick="createGroup()">CREA GRUPPO</button>
    <button class="btn bg" onclick="hideM('group-ov')">Annulla</button>
  </div>
</div>

<!-- WALLET -->
<div class="overlay hidden" id="wallet-ov">
  <div class="mcard">
    <div class="mtitle">ü™ô Portafoglio YOULI</div>
    <div style="background:linear-gradient(135deg,#1c1c2e,#2d2d44);border-radius:13px;padding:14px;text-align:center;margin-bottom:14px">
      <div style="font-size:10px;color:rgba(255,255,255,.45);letter-spacing:1px;text-transform:uppercase">Saldo</div>
      <div style="font-size:34px;font-weight:900;color:var(--youli)" id="wmodbal">0.00</div>
      <div style="font-size:10px;color:rgba(255,255,255,.35)">YOULI TOKEN</div>
    </div>
    <div id="redeem-result" style="display:none;margin-bottom:12px">
      <div style="font-size:12px;font-weight:600;color:var(--text2);margin-bottom:5px">Voucher creato:</div>
      <div class="ycodeshow" id="rcode">---</div>
      <button class="btn bg" style="width:auto;padding:6px 14px;font-size:12px;margin:0 auto" onclick="copyRcode()">üìã Copia</button>
    </div>
    <button class="btn bp" onclick="riscatta()">üí∞ CONVERTI IN VOUCHER</button>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin-top:6px">Min. 1.00 YOULI</div>
    <hr class="div"/>
    <!-- INSERISCI CODICE -->
    <div class="cinpbox">
      <div style="font-size:11px;font-weight:700;color:var(--youli);letter-spacing:.4px;margin-bottom:9px">üéü INSERISCI CODICE</div>
      <div class="cinprow">
        <input class="inp" id="cinp" placeholder="5329HL7614a646hN593 o YLN-XXXX-..." oninput="resetFb()" onkeydown="if(event.key==='Enter')redeemCode()"/>
        <button class="cbtn" onclick="redeemCode()">RISCATTA</button>
      </div>
      <div id="codefb"></div>
    </div>
    <hr class="div"/>
    <div style="font-size:11px;font-weight:700;color:var(--text2);margin-bottom:7px">Storico</div>
    <div id="whistory" style="max-height:130px;overflow-y:auto"></div>
    <button class="btn bg" onclick="hideM('wallet-ov')">Chiudi</button>
  </div>
</div>

<!-- POLL -->
<div class="overlay hidden" id="poll-ov">
  <div class="mcard">
    <div class="mtitle">üìä Sondaggio</div>
    <div class="inp-wrap"><label class="ilabel">DOMANDA</label><input class="inp" id="pq" placeholder="Cosa preferisci?"/></div>
    <div class="inp-wrap"><label class="ilabel">OPZIONE A</label><input class="inp" id="pa" placeholder="Prima scelta"/></div>
    <div class="inp-wrap"><label class="ilabel">OPZIONE B</label><input class="inp" id="pb" placeholder="Seconda scelta"/></div>
    <button class="btn bp" onclick="sendPoll()">INVIA</button>
    <button class="btn bg" onclick="hideM('poll-ov')">Annulla</button>
  </div>
</div>

<!-- SNAKE -->
<div class="overlay hidden" id="snake-ov">
  <div class="mcard" style="width:320px;max-width:96vw">
    <div class="snakestats">
      <span>Punti: <b id="sscore" style="color:var(--blue)">0</b></span>
      <span>Guadagnato: <b id="syouli" style="color:var(--youli)">+0.00 YL</b></span>
    </div>
    <canvas id="sCanvas" width="280" height="280"></canvas>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin-top:7px">‚¨Ü‚¨á‚¨Ö‚û° oppure swipe ¬∑ Ogni mela = <b>+0.01 YL</b></div>
    <button class="btn bd" style="margin-top:9px" onclick="hideM('snake-ov');clearInterval(snakeLoop)">ESCI</button>
  </div>
</div>

<!-- SETTINGS -->
<div class="overlay hidden" id="sett-ov">
  <div class="mcard">
    <div class="mtitle">‚öôÔ∏è Impostazioni</div>
    <hr class="div"/>
    <div style="font-size:12px;font-weight:700;color:var(--text2);margin-bottom:10px">üîí Cambia Password</div>
    <div class="inp-wrap"><label class="ilabel">PASSWORD ATTUALE</label><input class="inp" id="oldp" type="password" placeholder="Password corrente"/></div>
    <div class="inp-wrap"><label class="ilabel">NUOVA PASSWORD</label><input class="inp" id="newp" type="password" placeholder="Nuova password (min. 6)"/></div>
    <div class="inp-wrap"><label class="ilabel">CONFERMA NUOVA</label><input class="inp" id="newp2" type="password" placeholder="Ripeti nuova password"/></div>
    <button class="btn bp" onclick="changePwd()">AGGIORNA PASSWORD</button>
    <hr class="div"/>
    <button class="btn" style="background:var(--bg);color:var(--text);width:100%;margin-bottom:8px" onclick="exportData()">üì§ Esporta Dati</button>
    <button class="btn bd" onclick="resetApp()">üóë RESET TOTALE</button>
    <button class="btn bg" onclick="hideM('sett-ov')">Chiudi</button>
    <div id="pwderr" style="color:var(--red);font-size:12px;text-align:center;margin-top:8px;min-height:14px"></div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   YOULINIRI PRO v6.0 ‚Äî Core JS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const $=id=>document.getElementById(id),qs=s=>document.querySelector(s);

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function toast(m,d=2500){const e=$('toast');e.textContent=m;e.classList.add('show');clearTimeout(toast._t);toast._t=setTimeout(()=>e.classList.remove('show'),d);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
function showM(id){$(id).classList.remove('hidden')}
function hideM(id){$(id).classList.add('hidden')}

/* ‚îÄ‚îÄ COOKIE ‚îÄ‚îÄ */
function setCk(n,v,d=365){const e=new Date();e.setTime(e.getTime()+d*86400000);document.cookie=`${n}=${encodeURIComponent(v)};expires=${e.toUTCString()};path=/;SameSite=Strict`}
function getCk(n){const m=document.cookie.match(new RegExp('(?:^|; )'+n+'=([^;]*)'));return m?decodeURIComponent(m[1]):null}
function delCk(n){setCk(n,'',-1)}

/* ‚îÄ‚îÄ LOCAL STORAGE ‚îÄ‚îÄ */
const LS={get:k=>{try{return JSON.parse(localStorage.getItem(k))}catch{return null}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),del:k=>localStorage.removeItem(k)};

/* ‚îÄ‚îÄ COLORS ‚îÄ‚îÄ */
const COLORS=['#007aff','#34c759','#ff9500','#ff3b30','#af52de','#ff2d55','#5ac8fa','#ff6b35'];
function colorFor(n){let h=0;for(const c of(n||'?'))h=(h*31+c.charCodeAt(0))&0xffff;return COLORS[h%COLORS.length]}
const EMOJIS=['üòÄ','ü¶ä','üêº','ü¶Å','üêØ','üêª','ü¶Ñ','üê∏','üêô','ü¶ã','üöÄ','üåü','üé≠','üê¨','üéÆ'];
function randEmoji(){return EMOJIS[Math.floor(Math.random()*EMOJIS.length)]}

/* ‚îÄ‚îÄ HTML ESCAPE ‚îÄ‚îÄ */
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function fmtT(d){return new Date(d).toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'})}
function fmtSz(b){return b<1024?b+' B':b<1048576?(b/1024).toFixed(1)+' KB':(b/1048576).toFixed(1)+' MB'}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PRIVACY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function initPrivacy(){
  if(getCk('yl_priv')==='1'){hideM('priv-ov');initAuth();return}
  showM('priv-ov');
  const c1=$('chk1'),c2=$('chk2'),b=$('priv-btn');
  const chk=()=>{b.disabled=!(c1.checked&&c2.checked)};
  c1.onchange=c2.onchange=chk;
  b.onclick=()=>{setCk('yl_priv','1');hideM('priv-ov');initAuth()};
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUTH ‚Äî dati sul server
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let CU=null; // currentUser

function initAuth(){
  const s=getCk('yl_ses');
  if(s){
    // Prova login automatico
    const u=getCk('yl_u'),p=getCk('yl_p');
    if(u&&p){doLoginDirect(u,atob(p),true);return}
  }
  showM('auth-ov');
}

function stab(t){
  $('tl').classList.toggle('act',t==='l');
  $('ts').classList.toggle('act',t==='s');
  $('lform').style.display=t==='l'?'block':'none';
  $('sform').style.display=t==='s'?'block':'none';
  $('auth-err').textContent='';
}

function authErr(m){$('auth-err').textContent=m}

function doLogin(){doLoginDirect($('l-u').value.trim(),$('l-p').value,false)}

function doLoginDirect(u,p,auto){
  if(!u||!p){authErr('Compila tutti i campi');return}
  const users=LS.get('yl_users')||{};
  if(!users[u]){authErr('Utente non trovato');return}
  if(users[u].pass!==btoa(p)){authErr('Password errata');return}
  CU={...users[u],username:u};
  setCk('yl_ses','1');setCk('yl_u',u);setCk('yl_p',btoa(p));
  hideM('auth-ov');
  launchApp();
}

function doSignup(){
  const name=$('s-n').value.trim();
  const u=$('s-u').value.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  const p=$('s-p').value,p2=$('s-p2').value;
  if(!name||!u||!p){authErr('Compila tutti i campi');return}
  if(u.length<2){authErr('Username troppo corto');return}
  if(p.length<6){authErr('Password min. 6 caratteri');return}
  if(p!==p2){authErr('Le password non coincidono');return}
  const users=LS.get('yl_users')||{};
  if(users[u]){authErr('Username gi√† in uso');return}
  const nu={name,pass:btoa(p),balance:0,redemptions:[],emoji:randEmoji(),contacts:[]};
  users[u]=nu;
  LS.set('yl_users',users);
  CU={...nu,username:u};
  setCk('yl_ses','1');setCk('yl_u',u);setCk('yl_p',btoa(p));
  hideM('auth-ov');
  launchApp();
}

function doLogout(){
  if(!confirm('Vuoi uscire?'))return;
  delCk('yl_ses');delCk('yl_u');delCk('yl_p');
  peer&&peer.destroy();location.reload();
}

function saveU(){
  const users=LS.get('yl_users')||{};
  users[CU.username]={...CU};
  LS.set('yl_users',users);
}

function changePwd(){
  const op=$('oldp').value,np=$('newp').value,np2=$('newp2').value;
  const e=$('pwderr');e.textContent='';
  if(!op||!np){e.textContent='Compila tutti i campi';return}
  if(CU.pass!==btoa(op)){e.textContent='‚ùå Password attuale errata';return}
  if(np.length<6){e.textContent='Nuova password min. 6 caratteri';return}
  if(np!==np2){e.textContent='Le password non coincidono';return}
  CU.pass=btoa(np);
  saveU();
  setCk('yl_p',btoa(np));
  $('oldp').value='';$('newp').value='';$('newp2').value='';
  hideM('sett-ov');
  toast('‚úÖ Password aggiornata con successo!');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PEERJS ‚Äî connessione con retry
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let peer,myPeerID,conns={},callCon,callTimer;
let peerRetries=0;

function initPeer(){
  if(peer){try{peer.destroy()}catch{}}
  const pid='yln_'+CU.username;
  peer=new Peer(pid,{debug:0});
  setConnStatus('connecting');

  peer.on('open',id=>{
    myPeerID=id;
    $('mypeerid').textContent=id;
    setConnStatus('online');
    peerRetries=0;
    toast('üü¢ Connesso come '+id,2000);
  });

  peer.on('connection',conn=>{
    conn.on('open',()=>{conns[conn.peer]=conn;updateCstatus(conn.peer,true)});
    conn.on('data',d=>recvData(d,conn.peer));
    conn.on('close',()=>{updateCstatus(conn.peer,false);delete conns[conn.peer]});
    conn.on('error',()=>{updateCstatus(conn.peer,false);delete conns[conn.peer]});
  });

  peer.on('call',handleIncoming);

  peer.on('disconnected',()=>{
    setConnStatus('offline');
    // Auto-reconnect
    setTimeout(()=>{
      if(peer.disconnected){
        try{peer.reconnect()}catch{
          peerRetries++;
          if(peerRetries<5)setTimeout(initPeer,3000*peerRetries);
        }
      }
    },2000);
  });

  peer.on('error',err=>{
    if(err.type==='unavailable-id'){
      // ID gi√† preso, aggiungi suffisso
      myPeerID='yln_'+CU.username+'_'+Date.now().toString(36).slice(-4);
      peer.destroy();
      setTimeout(()=>{
        peer=new Peer(myPeerID);
        peer.on('open',id=>{$('mypeerid').textContent=id;setConnStatus('online')});
        peer.on('connection',conn=>{conn.on('open',()=>{conns[conn.peer]=conn});conn.on('data',d=>recvData(d,conn.peer))});
        peer.on('call',handleIncoming);
      },500);
    }else{
      setConnStatus('offline');
      setTimeout(()=>{if(peerRetries<5){peerRetries++;initPeer()}},4000);
    }
  });
}

function setConnStatus(s){
  const b=$('connbadge');
  const labels={online:'üü¢ Online',offline:'üî¥ Offline',connecting:'üü° Connessione...'};
  b.innerHTML=`<span class="connstatus ${s}">${labels[s]||s}</span>`;
  // Aggiorna dot sull'avatar
  const d=$('peerdot');
  if(d){d.style.background=s==='online'?'var(--green)':s==='offline'?'var(--red)':'var(--orange)'}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   APP LAUNCH
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let contacts=[], chatMsgs={};

function launchApp(){
  contacts=CU.contacts||[];
  $('myname').textContent=CU.name;
  $('myavl').textContent=CU.emoji||CU.name[0];
  $('myav').style.background=colorFor(CU.name);
  updateBal();
  renderContacts();
  $('app').classList.add('vis');
  initPeer();
  // Seed vault
  const vault=LS.get('yl_vault')||{};
  if(!vault['YLN-D3QV-GGR5-VYHQ-P3TN']){vault['YLN-D3QV-GGR5-VYHQ-P3TN']={value:1,used:false};LS.set('yl_vault',vault)}
  document.addEventListener('keydown',snakeKey);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONTACTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let activeCont=null;

function saveCont(){CU.contacts=contacts;saveU()}

function renderContacts(){
  const l=$('clist');
  if(!contacts.length){l.innerHTML='<div style="text-align:center;padding:28px;color:var(--text3);font-size:13px">Nessun contatto.<br/>Aggiungine uno!</div>';return}
  l.innerHTML='';
  contacts.forEach(c=>{
    const isG=!!c.isGroup;
    const d=document.createElement('div');
    d.className='ci'+(activeCont?.id===c.id?' act':'');
    d.id='ci_'+c.id.replace(/\W/g,'_');
    const msgs=chatMsgs[c.id]||[];
    const last=msgs[msgs.length-1];
    d.innerHTML=`
      <div class="cav" style="background:${colorFor(c.name)}">${c.emoji||c.name[0]}</div>
      <div class="cinfo">
        <div class="cname">${esc(c.name)}${isG?'<span class="gbadge">GRUPPO</span>':''}</div>
        <div class="cprev">${last?prevMsg(last):'<i style="opacity:.5">Nessun messaggio</i>'}</div>
      </div>
      <div class="ctime">${last?fmtT(last.ts):''}</div>
    `;
    d.onclick=()=>{openChat(c);if(window.innerWidth<=640)closeSidebar()};
    l.appendChild(d);
  });
}

function prevMsg(m){
  const map={text:t=>esc(t.content.slice(0,38)),file:t=>'üìÅ '+t.name,audio:_=>'üéôÔ∏è Vocale',image:_=>'üñºÔ∏è Immagine',video:_=>'üé¨ Video',poll:_=>'üìä Sondaggio',map:_=>'üìç Posizione',youli_gift:t=>'ü™ô +'+t.amount+' YL'};
  return(map[m.type]||(_=>'üì®'))(m);
}

function openChat(c){
  activeCont=c;
  renderContacts();
  $('nochat').style.display='none';
  const ac=$('activechat');ac.style.display='flex';
  const col=colorFor(c.name);
  $('chhav').style.background=col;$('chhav').textContent=c.emoji||c.name[0];
  $('chname').textContent=c.name+(c.isGroup?' üë•':'');
  const on=c.isGroup?true:!!conns[c.id];
  $('chstatus').textContent=on?'‚óè online':'‚óã offline';
  $('chstatus').style.color=on?'var(--green)':'var(--text3)';
  if(!c.isGroup&&!conns[c.id])connTo(c.id);
  renderMsgs(c.id);
}

function connTo(pid){
  if(conns[pid])return;
  try{
    const c=peer.connect(pid,{reliable:true});
    c.on('open',()=>{conns[pid]=c;updateCstatus(pid,true)});
    c.on('data',d=>recvData(d,pid));
    c.on('close',()=>{updateCstatus(pid,false);delete conns[pid]});
    c.on('error',()=>{updateCstatus(pid,false);delete conns[pid]});
  }catch(e){}
}

function updateCstatus(pid,on){
  if(activeCont?.id===pid){
    $('chstatus').textContent=on?'‚óè online':'‚óã offline';
    $('chstatus').style.color=on?'var(--green)':'var(--text3)';
  }
}

function addCont(){
  const n=$('fc-n').value.trim(),i=$('fc-i').value.trim();
  if(!n||!i){toast('Compila nome e ID');return}
  if(contacts.find(c=>c.id===i)){toast('Contatto gi√† presente');return}
  contacts.push({name:n,id:i,emoji:randEmoji()});
  saveCont();renderContacts();hideM('addcont-ov');
  $('fc-n').value='';$('fc-i').value='';
  toast('‚úÖ Contatto aggiunto');
}

function copyID(){navigator.clipboard.writeText(myPeerID||$('mypeerid').textContent).then(()=>toast('üìã ID copiato!'))}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GROUPS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showGroupModal(){
  const gm=$('gmembers');gm.innerHTML='';
  contacts.filter(c=>!c.isGroup).forEach(c=>{
    const div=document.createElement('div');div.className='gm-member';
    div.innerHTML=`<input type="checkbox" value="${esc(c.id)}" id="gc_${esc(c.id)}"/><div class="cav" style="width:28px;height:28px;font-size:12px;background:${colorFor(c.name)}">${c.emoji||c.name[0]}</div><label for="gc_${esc(c.id)}" style="cursor:pointer;font-size:13px">${esc(c.name)}</label>`;
    gm.appendChild(div);
  });
  showM('group-ov');
}

function createGroup(){
  const gname=$('g-n').value.trim();
  if(!gname){toast('Inserisci il nome del gruppo');return}
  const checked=[...$('gmembers').querySelectorAll('input:checked')].map(i=>i.value);
  if(checked.length<1){toast('Seleziona almeno un membro');return}
  const gid='grp_'+Date.now();
  const members=checked.map(id=>contacts.find(c=>c.id===id)).filter(Boolean);
  contacts.push({name:gname,id:gid,emoji:'üë•',isGroup:true,members:checked});
  saveCont();renderContacts();hideM('group-ov');
  $('g-n').value='';
  toast('‚úÖ Gruppo "'+gname+'" creato con '+members.length+' membri');
}

// Override showM for group
const origShowM=showM;
window.showM=function(id){if(id==='group-ov'){showGroupModal();return}origShowM(id)};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MESSAGES ‚Äî RENDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderMsgs(pid){
  const box=$('msgbox');box.innerHTML='';
  const msgs=chatMsgs[pid]||[];
  let lastDay='';
  msgs.forEach(m=>{
    const day=new Date(m.ts).toLocaleDateString('it-IT',{weekday:'long',day:'numeric',month:'long'});
    if(day!==lastDay){const d=document.createElement('div');d.className='daydiv';d.innerHTML=`<span>${day}</span>`;box.appendChild(d);lastDay=day}
    box.appendChild(buildMsg(m));
  });
  box.scrollTop=box.scrollHeight;
}

function buildMsg(m){
  const wrap=document.createElement('div');
  wrap.className='mwrap '+m.side;
  const me=m.side==='me';
  let inner='';
  if(m.type==='text'){
    inner=`<div class="bub">${esc(m.content).replace(/\n/g,'<br/>')}</div>`;
  }else if(m.type==='image'){
    inner=`<img src="${m.data}" style="max-width:210px;border-radius:14px;display:block;cursor:pointer" onclick="window.open(this.src)"/>`;
  }else if(m.type==='video'){
    inner=`<video src="${m.data}" controls style="max-width:230px;border-radius:14px;display:block"></video>`;
  }else if(m.type==='audio'&&m.isVoice){
    inner=`<div class="abub"><button class="aplay" onclick="playAud('${m.data}',this)">‚ñ∂</button><div style="flex:1;height:28px;background:currentColor;opacity:.2;border-radius:3px"></div><span class="adur">${m.dur||'0:00'}</span></div>`;
  }else if(m.type==='file'||m.type==='audio'){
    const ico=ficon(m.name||'');
    inner=`<a href="${m.data}" download="${esc(m.name||'file')}" class="fbub" style="text-decoration:none">
      <div class="ficon">${ico}</div>
      <div><div class="fname">${esc(m.name||'file')}</div><div class="fsize">${m.size||''} ‚Ä¢ scarica</div></div></a>`;
  }else if(m.type==='poll'){
    inner=`<div class="bub pbub"><div class="pq">üìä ${esc(m.q)}</div>
      <button class="popt" onclick="toast('Votato: ${esc(m.a)}')">${esc(m.a)}</button>
      <button class="popt" onclick="toast('Votato: ${esc(m.b)}')">${esc(m.b)}</button></div>`;
  }else if(m.type==='map'){
    inner=`<a href="${m.url}" target="_blank" style="text-decoration:none">
      <div style="border-radius:14px;overflow:hidden;background:#e5e5ea;width:200px;height:110px;display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--text2)">
        üìç ${(m.lat||0).toFixed(4)}, ${(m.lng||0).toFixed(4)}</div></a>`;
  }else if(m.type==='youli_gift'){
    inner=`<div class="ygift"><div style="font-size:22px">ü™ô</div>
      <div style="font-size:11px;opacity:.55;margin:3px 0">Da ${esc(m.fromName||'?')}</div>
      <div class="yamount">+${m.amount} YL</div>
      <div class="ycode">${esc(m.code)}</div>
      <button onclick="claimGift('${esc(m.code)}','${m.amount}')" style="margin-top:8px;background:var(--youli);border:none;border-radius:8px;padding:6px 14px;font-weight:700;font-size:12px;cursor:pointer;color:#1c1c1e">RISCATTA</button>
      </div>`;
  }
  wrap.innerHTML=`${!me&&m.fromName?`<div class="mauthor">${esc(m.fromName)}</div>`:''}${inner}<div class="mtime">${fmtT(m.ts)}${me?' <span style="opacity:.6">‚úì</span>':''}</div>`;
  return wrap;
}

function appendMsg(m){
  const box=$('msgbox');
  box.appendChild(buildMsg(m));
  box.scrollTop=box.scrollHeight;
  renderContacts();
}

function saveAndShow(pid,m){
  if(!chatMsgs[pid])chatMsgs[pid]=[];
  chatMsgs[pid].push(m);
  appendMsg(m);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SEND
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sendPayload(data){
  if(!activeCont){toast('Seleziona un contatto');return}
  const pid=activeCont.id;
  const targets=activeCont.isGroup?(activeCont.members||[]):[pid];
  targets.forEach(tid=>{
    connTo(tid);
    const doSend=()=>{try{conns[tid]&&conns[tid].send({...data,from:myPeerID,fromName:CU.name})}catch{}};
    if(conns[tid]?.open)doSend();else setTimeout(doSend,900);
  });
}

function sendText(){
  const v=$('msginput').value.trim();
  if(!v||!activeCont)return;
  const m={type:'text',content:v,ts:Date.now(),side:'me'};
  saveAndShow(activeCont.id,m);
  sendPayload(m);
  $('msginput').value='';autoR($('msginput'));
}

function msgKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendText()}}
function autoR(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,110)+'px'}

/* FILES */
function ficon(n){
  const ext=(n||'').split('.').pop().toLowerCase();
  const m={pdf:'üìÑ',py:'üêç',js:'üìú',html:'üåê',css:'üé®',php:'üêò',txt:'üìù',apk:'üì±',exe:'üíæ',zip:'üóúÔ∏è',rar:'üóúÔ∏è',mp3:'üéµ',wav:'üéµ',mp4:'üé¨',avi:'üé¨',mov:'üé¨',jpg:'üñºÔ∏è',jpeg:'üñºÔ∏è',png:'üñºÔ∏è',gif:'üñºÔ∏è',doc:'üìù',docx:'üìù',xls:'üìä',xlsx:'üìä',json:'üîß',sql:'üóÑÔ∏è',db:'üóÑÔ∏è',csv:'üìä',xml:'üîß',sh:'‚ö°',bat:'‚ö°',cpp:'üíª',c:'üíª',java:'‚òï',rb:'üíé',go:'üêπ',rs:'ü¶Ä',ts:'üìò',vue:'üíö',svelte:'üî•'};
  return m[ext]||'üìÅ';
}

function trigF(acc){
  $('finput').accept=acc;$('finput').click();togAmenu();
}

function handleFile(inp){
  const file=inp.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=e=>{
    const t=file.type.startsWith('image/')?'image':file.type.startsWith('video/')?'video':file.type.startsWith('audio/')?'audio':'file';
    const m={type:t,name:file.name,data:e.target.result,size:fmtSz(file.size),ts:Date.now(),side:'me'};
    saveAndShow(activeCont.id,m);sendPayload(m);
  };
  r.readAsDataURL(file);inp.value='';
}

/* LOCATION */
function sendLoc(){
  togAmenu();
  if(!navigator.geolocation){toast('GPS non disponibile');return}
  navigator.geolocation.getCurrentPosition(p=>{
    const m={type:'map',lat:p.coords.latitude,lng:p.coords.longitude,url:`https://maps.google.com?q=${p.coords.latitude},${p.coords.longitude}`,ts:Date.now(),side:'me'};
    saveAndShow(activeCont.id,m);sendPayload(m);
  },()=>toast('Posizione negata'));
}

/* POLL */
function sendPoll(){
  const q=$('pq').value.trim(),a=$('pa').value.trim(),b=$('pb').value.trim();
  if(!q||!a||!b){toast('Compila tutti i campi');return}
  const m={type:'poll',q,a,b,ts:Date.now(),side:'me'};
  saveAndShow(activeCont.id,m);sendPayload(m);
  hideM('poll-ov');$('pq').value='';$('pa').value='';$('pb').value='';
}

/* YOULI GIFT */
function sendYouliGift(){
  togAmenu();
  const amt=parseFloat(prompt('Quanti YOULI vuoi inviare?\n(Saldo: '+(CU.balance||0).toFixed(2)+' YL)')||'0');
  if(!amt||isNaN(amt)||amt<=0){toast('Importo non valido');return}
  if(amt>(CU.balance||0)){toast('Saldo insufficiente');return}
  CU.balance=parseFloat(((CU.balance||0)-amt).toFixed(2));
  saveU();updateBal();
  const code=genCode();
  // Salva nel vault
  const v=LS.get('yl_vault')||{};
  v[code]={value:amt,used:false,createdBy:CU.username};
  LS.set('yl_vault',v);
  const m={type:'youli_gift',amount:amt.toFixed(2),code,from:myPeerID,fromName:CU.name,ts:Date.now(),side:'me'};
  saveAndShow(activeCont.id,m);sendPayload(m);
}

function claimGift(code,amount){
  const v=LS.get('yl_vault')||{};
  const used=LS.get('yl_used')||[];
  if(used.includes(code)){toast('‚ö† Gi√† riscattato');return}
  if(v[code]&&v[code].used){toast('‚ö† Gi√† riscattato');return}
  const val=v[code]?v[code].value:parseFloat(amount)||0;
  CU.balance=parseFloat(((CU.balance||0)+val).toFixed(2));
  if(v[code]){v[code].used=true;LS.set('yl_vault',v)}
  used.push(code);LS.set('yl_used',used);
  saveU();updateBal();
  toast('ü™ô +'+val.toFixed(2)+' YOULI aggiunti al saldo!',3000);
}

/* AUDIO PLAY */
function playAud(src,btn){
  const a=new Audio(src);btn.textContent='‚è∏';a.play();a.onended=()=>btn.textContent='‚ñ∂';
}

/* RECEIVE */
function recvData(data,from){
  if(!data||!data.type)return;
  const cont=contacts.find(c=>c.id===from);
  const m={...data,side:'them',fromName:cont?.name||data.fromName||from};
  if(!chatMsgs[from])chatMsgs[from]=[];
  chatMsgs[from].push(m);
  if(activeCont?.id===from)appendMsg(m);
  if(data.type==='youli_gift'){
    toast(`ü™ô ${cont?.name||'Qualcuno'} ti ha inviato ${data.amount} YOULI! Aprila per riscattarla.`,4000);
  }
  renderContacts();
}

/* ATTACH / SIDEBAR TOGGLE */
function togAmenu(){$('amenu').classList.toggle('hidden')}
function toggleSidebar(){$('sidebar').classList.toggle('open')}
function closeSidebar(){$('sidebar').classList.remove('open')}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AUDIO RECORDING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let mrec=null,achunks=[],recTI,recS=0;

function togRec(){if(mrec&&mrec.state==='recording')return;startRec()}

async function startRec(){
  try{
    const s=await navigator.mediaDevices.getUserMedia({audio:true});
    mrec=new MediaRecorder(s);achunks=[];recS=0;
    mrec.ondataavailable=e=>achunks.push(e.data);mrec.start();
    $('recbar').classList.remove('hidden');
    $('msginput').style.display='none';$('sendbtn')||null;
    $('recbtn').style.background='var(--red)';
    recTI=setInterval(()=>{recS++;$('rectime').textContent=`${Math.floor(recS/60)}:${String(recS%60).padStart(2,'0')}`},1000);
  }catch{toast('Microfono non disponibile')}
}

function stopRec(cancel){
  if(!mrec)return;
  clearInterval(recTI);
  mrec.onstop=()=>{
    if(!cancel&&achunks.length){
      const blob=new Blob(achunks,{type:'audio/webm'});
      const fr=new FileReader();
      fr.onload=e=>{
        const m={type:'audio',isVoice:true,data:e.target.result,dur:$('rectime').textContent,ts:Date.now(),side:'me'};
        saveAndShow(activeCont.id,m);sendPayload(m);
      };fr.readAsDataURL(blob);
    }
    mrec.stream.getTracks().forEach(t=>t.stop());mrec=null;
  };
  mrec.stop();
  $('recbar').classList.add('hidden');
  $('msginput').style.display='';
  $('recbtn').style.background='';
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CALLS ‚Äî WebRTC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let locStream=null,curCall=null,callType='audio';
let isMuted=false,isCamOff=false,isPiP=false;

async function startCall(type){
  if(!activeCont||activeCont.isGroup){toast('Seleziona un contatto (non gruppo)');return}
  callType=type;
  try{
    let s;
    if(type==='screen')s=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    else s=await navigator.mediaDevices.getUserMedia({video:type==='video',audio:true});
    locStream=s;
    $('localv').srcObject=s;
    if(type!=='audio'){$('localv').style.display='block'}
    curCall=peer.call(activeCont.id,s,{metadata:{type,callerName:CU.name}});
    curCall.on('stream',rs=>{$('remotev').srcObject=rs;$('remotev').style.display='block';$('callav').style.display='none';$('callst').textContent='üî¥ In chiamata'});
    curCall.on('close',cleanCall);
    showCallUI(activeCont.name,type,true);
  }catch(e){toast('Errore accesso media: '+e.message)}
}

function handleIncoming(call){
  curCall=call;
  callType=call.metadata?.type||'audio';
  const name=call.metadata?.callerName||'Sconosciuto';
  $('incav').style.background=colorFor(name);$('incav').textContent=name[0];
  $('incname').textContent=name;
  $('inctype').textContent=callType==='video'?'üìπ Videochiamata':callType==='screen'?'üñ•Ô∏è Condivisione schermo':'üìû Chiamata audio';
  showM('incall');
}

async function accCall(){
  hideM('incall');
  try{
    const s=await navigator.mediaDevices.getUserMedia({video:callType==='video',audio:true});
    locStream=s;$('localv').srcObject=s;
    if(callType==='video')$('localv').style.display='block';
    curCall.answer(s);
    curCall.on('stream',rs=>{$('remotev').srcObject=rs;$('remotev').style.display='block';$('callav').style.display='none';$('callst').textContent='üî¥ In chiamata'});
    curCall.on('close',cleanCall);
    showCallUI(curCall.metadata?.callerName||'Contatto',callType,false);
  }catch(e){toast('Errore: '+e.message)}
}

function rejCall(){curCall&&curCall.close();curCall=null;hideM('incall')}

function showCallUI(name,type,caller){
  $('callav').style.background=colorFor(name);$('callav').textContent=name[0];
  $('callname').textContent=name;
  $('callst').textContent=caller?'‚è≥ In attesa...':'üî¥ In chiamata';
  $('filterbar').classList.toggle('hidden',type==='audio');
  $('callover').classList.remove('hidden');
  let sec=0;
  clearInterval(callTimer);
  callTimer=setInterval(()=>{sec++;$('calllbl').textContent=`üîí ${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')} ¬∑ WebRTC E2E`},1000);
}

function endCall(){curCall&&curCall.close();cleanCall()}

function cleanCall(){
  clearInterval(callTimer);
  locStream&&locStream.getTracks().forEach(t=>t.stop());locStream=null;
  $('remotev').srcObject=null;$('localv').srcObject=null;
  $('remotev').style.display='none';$('localv').style.display='none';
  $('callav').style.display='flex';
  const co=$('callover');co.classList.add('hidden');co.classList.remove('pip');
  co.style.left='';co.style.top='';co.style.bottom='16px';co.style.right='16px';
  isPiP=false;isMuted=false;isCamOff=false;
  $('bmute').textContent='üé§';$('bcam').textContent='üì∑';
  $('bmute').classList.remove('act');$('bcam').classList.remove('act');
}

function togMute(){if(!locStream)return;isMuted=!isMuted;locStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);$('bmute').textContent=isMuted?'üîá':'üé§';$('bmute').classList.toggle('act',isMuted)}
function togCam(){if(!locStream)return;isCamOff=!isCamOff;locStream.getVideoTracks().forEach(t=>t.enabled=!isCamOff);$('bcam').textContent=isCamOff?'üö´':'üì∑';$('bcam').classList.toggle('act',isCamOff)}
function togFilters(){$('filterbar').classList.toggle('hidden')}
function applyF(f,btn){$('remotev').style.filter=f;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('act'));btn.classList.add('act')}

/* PiP ‚Äî trascina ovunque, desktop e mobile */
function togPiP(){
  isPiP=!isPiP;
  const co=$('callover');
  co.classList.toggle('pip',isPiP);
  $('bpip').classList.toggle('act',isPiP);
  if(isPiP){
    co.style.bottom='16px';co.style.right='16px';co.style.left='auto';co.style.top='auto';
    makeDrag(co);
    toast('üí° Trascina la finestra ovunque',2000);
  }else{
    co.style.cssText='';
    co.onmousedown=null;co.ontouchstart=null;
  }
}

function makeDrag(el){
  const drag=(ox,oy)=>({
    move:(cx,cy)=>{
      const r=el.getBoundingClientRect();
      el.style.left=(r.left+cx-ox)+'px';el.style.top=(r.top+cy-oy)+'px';
      el.style.right='auto';el.style.bottom='auto';
      ox=cx;oy=cy;
    }
  });
  el.onmousedown=e=>{
    if(e.target.tagName==='BUTTON'||e.target.tagName==='VIDEO')return;
    e.preventDefault();
    const d=drag(e.clientX,e.clientY);
    const mm=e2=>d.move(e2.clientX,e2.clientY);
    const mu=()=>{document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu)};
    document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);
  };
  el.ontouchstart=e=>{
    if(e.target.tagName==='BUTTON'||e.target.tagName==='VIDEO')return;
    const t=e.touches[0];const d=drag(t.clientX,t.clientY);
    el.ontouchmove=ev=>{const t2=ev.touches[0];d.move(t2.clientX,t2.clientY);ev.preventDefault()};
    el.ontouchend=()=>{el.ontouchmove=null;el.ontouchend=null};
  };
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   WALLET / YOULI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const OFFICIAL={
  '5329HL7614a646hN593':5,
  '75nC639hH1L2M2NA':5,
  '43510Npy462A598317d':10
};

function updateBal(){$('balval').textContent=(CU.balance||0).toFixed(2)}

function showWallet(){
  $('wmodbal').textContent=(CU.balance||0).toFixed(2);
  $('redeem-result').style.display='none';
  $('cinp').value='';$('codefb').textContent='';$('codefb').style.color='';
  renderHist();showM('wallet-ov');
}

function genCode(){
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const s=n=>Array.from({length:n},()=>c[Math.random()*c.length|0]).join('');
  return `YLN-${s(4)}-${s(4)}-${s(4)}-${s(4)}`;
}

function riscatta(){
  const bal=CU.balance||0;
  if(bal<1){toast('‚ö† Minimo 1.00 YOULI');return}
  const code=genCode(),amt=parseFloat(bal.toFixed(2));
  const v=LS.get('yl_vault')||{};
  v[code]={value:amt,used:false,createdBy:CU.username};
  LS.set('yl_vault',v);
  if(!CU.redemptions)CU.redemptions=[];
  CU.redemptions.push({code,amount:amt.toFixed(2),date:new Date().toLocaleDateString('it-IT'),type:'OUT'});
  CU.balance=0;saveU();updateBal();
  $('wmodbal').textContent='0.00';
  $('rcode').textContent=code;
  $('redeem-result').style.display='block';
  renderHist();toast('üéâ Voucher creato! Condividilo o riscattalo tu stesso.');
}

function copyRcode(){navigator.clipboard.writeText($('rcode').textContent).then(()=>toast('üìã Codice copiato!'))}

function resetFb(){$('codefb').textContent='';$('codefb').style.color=''}

function redeemCode(){
  const raw=$('cinp').value.trim();
  const fb=$('codefb');
  if(!raw){fb.textContent='‚ö† Inserisci un codice';fb.style.color='var(--orange)';return}
  const used=LS.get('yl_used')||[];
  if(used.includes(raw)){fb.textContent='‚úï Codice gi√† utilizzato';fb.style.color='var(--red)';return}
  let val=null,label='';
  // Codici ufficiali
  if(OFFICIAL[raw]!==undefined){val=OFFICIAL[raw];label='Codice Ufficiale'}
  // Vault YLN-*
  if(val===null){
    const v=LS.get('yl_vault')||{};
    const e=v[raw];
    if(e&&!e.used){val=e.value;label='Voucher YLN';e.used=true;e.usedBy=CU.username;LS.set('yl_vault',v)}
    else if(e&&e.used){fb.textContent='‚úï Voucher gi√† riscattato';fb.style.color='var(--red)';return}
  }
  if(val===null){
    fb.textContent='‚úï Codice non valido';fb.style.color='var(--red)';
    $('cinp').style.animation='none';void $('cinp').offsetHeight;$('cinp').style.animation='shake .3s ease';return;
  }
  CU.balance=parseFloat(((CU.balance||0)+val).toFixed(2));
  if(!CU.redemptions)CU.redemptions=[];
  CU.redemptions.push({code:raw,amount:'+'+parseFloat(val).toFixed(2),date:new Date().toLocaleDateString('it-IT'),type:'IN',source:label});
  used.push(raw);LS.set('yl_used',used);
  saveU();updateBal();$('wmodbal').textContent=CU.balance.toFixed(2);
  $('cinp').value='';
  fb.textContent=`‚úì +${parseFloat(val).toFixed(2)} YOULI accreditati!`;fb.style.color='var(--green)';
  renderHist();toast(`ü™ô +${parseFloat(val).toFixed(2)} YOULI aggiunti!`,3000);
}

function renderHist(){
  const h=$('whistory'),reds=CU.redemptions||[];
  if(!reds.length){h.innerHTML='<div style="color:var(--text3);font-size:11px;text-align:center;padding:9px">Nessuna operazione</div>';return}
  h.innerHTML=[...reds].reverse().map(r=>{
    const isIn=r.type==='IN'||String(r.amount).startsWith('+');
    return`<div class="hitem"><div class="hcode">${esc(r.code)}<div style="color:var(--text3);font-size:9px">${r.date}${r.source?' ¬∑ '+r.source:''}</div></div><div class="hamount ${isIn?'in':''}">${isIn?'':'-'}${String(r.amount).replace(/^[+-]/,'')} YL</div></div>`;
  }).join('');
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SNAKE ‚Äî 0.01 YL per mela
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let snakeLoop,sp,sd,sf,sscore=0,searned=0;
const SG=14;

function openSnake(){
  if($('amenu'))$('amenu').classList.add('hidden');
  sscore=0;searned=0;
  $('sscore').textContent=0;$('syouli').textContent='+0.00 YL';
  showM('snake-ov');initSnake();
}

function initSnake(){
  clearInterval(snakeLoop);
  const c=$('sCanvas'),ctx=c.getContext('2d'),SZ=c.width/SG;
  sp=[{x:7,y:7}];sd='R';sf=rSF();
  snakeLoop=setInterval(()=>{
    ctx.fillStyle='#0a0a1a';ctx.fillRect(0,0,c.width,c.height);
    ctx.strokeStyle='rgba(255,255,255,.03)';
    for(let i=0;i<SG;i++)for(let j=0;j<SG;j++)ctx.strokeRect(i*SZ,j*SZ,SZ,SZ);
    ctx.fillStyle='#ff3b30';ctx.beginPath();ctx.arc(sf.x*SZ+SZ/2,sf.y*SZ+SZ/2,SZ/2-1,0,Math.PI*2);ctx.fill();
    sp.forEach((p,i)=>{
      const g=ctx.createLinearGradient(p.x*SZ,p.y*SZ,p.x*SZ+SZ,p.y*SZ+SZ);
      g.addColorStop(0,i===0?'#34c759':'#007aff');g.addColorStop(1,i===0?'#00c75a':'#00c6ff');
      ctx.fillStyle=g;ctx.beginPath();ctx.roundRect(p.x*SZ+1,p.y*SZ+1,SZ-2,SZ-2,3);ctx.fill();
    });
    let h={...sp[0]};
    if(sd==='R')h.x++;if(sd==='L')h.x--;if(sd==='U')h.y--;if(sd==='D')h.y++;
    h.x=(h.x+SG)%SG;h.y=(h.y+SG)%SG;
    if(h.x===sf.x&&h.y===sf.y){
      sscore++;searned=parseFloat((searned+0.01).toFixed(2));
      CU.balance=parseFloat(((CU.balance||0)+0.01).toFixed(2));
      saveU();updateBal();
      $('sscore').textContent=sscore;$('syouli').textContent='+'+searned.toFixed(2)+' YL';
      sf=rSF();
    }else{sp.pop()}
    if(sp.some(p=>p.x===h.x&&p.y===h.y)){clearInterval(snakeLoop);toast('üíÄ Game Over! +'+searned.toFixed(2)+' YL guadagnati');return}
    sp.unshift(h);
  },120);
  // Swipe per mobile
  let sx=null,sy=null;
  c.ontouchstart=e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY;e.preventDefault()};
  c.ontouchmove=e=>{
    if(!sx)return;
    const dx=e.touches[0].clientX-sx,dy=e.touches[0].clientY-sy;
    if(Math.abs(dx)>Math.abs(dy)){sd=dx>0&&sd!=='L'?'R':dx<0&&sd!=='R'?'L':sd}
    else{sd=dy>0&&sd!=='U'?'D':dy<0&&sd!=='D'?'U':sd}
    sx=null;sy=null;e.preventDefault();
  },{passive:false};
}

function rSF(){return{x:Math.floor(Math.random()*SG),y:Math.floor(Math.random()*SG)}}

function snakeKey(e){
  if($('snake-ov').classList.contains('hidden'))return;
  const m={'ArrowUp':'U','ArrowDown':'D','ArrowLeft':'L','ArrowRight':'R'};
  const op={U:'D',D:'U',L:'R',R:'L'};
  const nd=m[e.key];if(nd&&op[nd]!==sd){sd=nd;e.preventDefault()}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MISC
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportData(){
  const b=new Blob([JSON.stringify({user:CU,contacts,messages:chatMsgs},null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='youliniri_backup.json';a.click();toast('üì§ Dati esportati');
}

function resetApp(){
  if(!confirm('ATTENZIONE: Tutti i dati verranno eliminati!'))return;
  localStorage.clear();document.cookie.split(';').forEach(c=>{const n=c.split('=')[0].trim();if(n)delCk(n)});location.reload();
}

/* START */
initPrivacy();
</script>
</body>
</html>
