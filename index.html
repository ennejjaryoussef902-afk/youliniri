import sqlite3
import tkinter as tk
import requests
from tkinter import messagebox, simpledialog
from datetime import datetime

class WalletDB:
    @staticmethod
    def init_tables(conn):
        """Inizializza le tabelle per saldo e codici usati"""
        conn.executescript("""
        CREATE TABLE IF NOT EXISTS wallet(uid TEXT PRIMARY KEY, balance REAL DEFAULT 0.0);
        CREATE TABLE IF NOT EXISTS wallet_codes(uid TEXT, code TEXT, PRIMARY KEY(uid, code));
        """)
        conn.commit()

    @staticmethod
    def get_balance(conn, uid):
        """Legge il saldo e corregge eventuali errori di struttura della tabella"""
        try:
            r = conn.execute("SELECT balance FROM wallet WHERE uid=?", (uid,)).fetchone()
            if not r:
                conn.execute("INSERT INTO wallet (uid, balance) VALUES (?, 0.0)", (uid,))
                conn.commit()
                return 0.0
            return r[0]
        except sqlite3.OperationalError:
            conn.execute("DROP TABLE IF EXISTS wallet")
            conn.execute("CREATE TABLE wallet(uid TEXT PRIMARY KEY, balance REAL DEFAULT 0.0)")
            conn.execute("INSERT INTO wallet VALUES (?, 0.0)", (uid,))
            conn.commit()
            return 0.0

    @staticmethod
    def redeem_code(conn, uid, code):
        """Invia il codice a vercel.app e aggiorna il db locale"""
        VERCEL_URL = "https://riscatta.vercel.app/api/check"
        
        already_used = conn.execute("SELECT 1 FROM wallet_codes WHERE uid=? AND code=?", (uid, code)).fetchone()
        if already_used:
            return False, "Codice gia inserito"

        try:
            res = requests.post(VERCEL_URL, json={"pin": code}, timeout=5)
            data = res.json()

            if res.status_code == 200 and data.get("success"):
                amount = float(data.get("amount"))
                conn.execute("UPDATE wallet SET balance = balance + ? WHERE uid = ?", (amount, uid))
                conn.execute("INSERT INTO wallet_codes (uid, code) VALUES (?, ?)", (uid, code))
                conn.commit()
                return True, f"Accreditati {amount:.2f} FC"
            else:
                return False, "Codice non valido"
        except:
            return False, "Errore connessione server"

class BalanceWidget(tk.Frame):
    """Widget testuale per il saldo in alto a destra"""
    def __init__(self, parent, db_conn, uid):
        super().__init__(parent, bg="#1E2C33", padx=10, pady=5)
        self.db_conn = db_conn
        self.uid = uid
        self.lbl = tk.Label(self, text="Saldo: 0.00 FC", font=("Consolas", 10, "bold"),
                            bg="#1E2C33", fg="#FFD700", cursor="hand2")
        self.lbl.pack()
        self.lbl.bind("<Button-1>", self.ask_code)
        self.refresh()

    def refresh(self):
        b = WalletDB.get_balance(self.db_conn, self.uid)
        self.lbl.config(text=f"Saldo: {b:.2f} FC")

    def ask_code(self, event):
        code = simpledialog.askstring("Riscatta", "Inserisci codice:")
        if code:
            ok, msg = WalletDB.redeem_code(self.db_conn, self.uid, code)
            if ok:
                messagebox.showinfo("Wallet", msg)
                self.refresh()
            else:
                messagebox.showerror("Errore", msg)

def init_wallet_system(conn):
    WalletDB.init_tables(conn)

def create_balance_widget(parent, conn, uid):
    w = BalanceWidget(parent, conn, uid)
    w.place(relx=1.0, rely=0.0, anchor="ne", x=-10, y=10)
    return w
